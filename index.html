<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --lagos-red: #DC2626;
            --lagos-blue: #1E40AF;
            --lagos-yellow: #FACC15;
            --lagos-green: #16A34A;
            --lagos-white: #FFFFFF;
            --lagos-navy: #1E3A8A;
            --lagos-dark-gray: #64748B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--lagos-blue);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: var(--lagos-navy);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--lagos-white);
            position: relative;
            border-left: 8px solid var(--lagos-red);
        }

        .header .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--lagos-white);
        }
        .header .logo img {
            height: 40px;
            width: 40px;
            margin-right: 12px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--lagos-green);
            box-shadow: 0 0 10px rgba(22, 163, 74, 0.5);
            border: 2px solid var(--lagos-white);
        }
        .status-dot.offline {
            background: var(--lagos-red);
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }

        .auth-container {
            background: var(--lagos-white);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 4px solid var(--lagos-blue);
            position: relative;
        }
        .auth-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--lagos-navy);
            font-size: 28px;
            position: relative;
            padding-left: 0;
        }
        .auth-title::after {
            content: 'Centre of Excellence';
            display: block;
            font-size: 12px;
            color: var(--lagos-blue);
            font-weight: normal;
            margin-top: 5px;
            font-style: italic;
        }
        .credentials-info {
            background: var(--lagos-yellow);
            border: 2px solid var(--lagos-green);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--lagos-navy);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--lagos-navy);
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--lagos-blue);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        .btn {
            width: 100%;
            padding: 14px;
            background: var(--lagos-blue);
            color: var(--lagos-white);
            border: 2px solid var(--lagos-red);
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: var(--lagos-red);
            border-color: var(--lagos-blue);
            color: var(--lagos-white);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background: var(--lagos-green);
            border-color: var(--lagos-yellow);
            color: var(--lagos-white);
        }
        .btn-secondary:hover {
            background: var(--lagos-yellow);
            border-color: var(--lagos-green);
            color: var(--lagos-navy);
        }
        .location-btn {
            background: var(--lagos-green);
            color: var(--lagos-white);
            border: 2px solid var(--lagos-yellow);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        .location-btn:hover {
            background: var(--lagos-yellow);
            border-color: var(--lagos-green);
            color: var(--lagos-navy);
            transform: translateY(-1px);
        }
        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            height: calc(100vh - 140px);
            position: relative;
        }
        .sidebar {
            background: var(--lagos-navy);
            border-radius: 15px;
            padding: 20px;
            color: var(--lagos-white);
            position: relative;
            border-left: 6px solid var(--lagos-red);
        }
        .sidebar::after {
           
            position: absolute;
            top: 20px;
            right: 20px;
            width: 20px;
            height: 20px;
            background: var(--lagos-yellow);
            border-radius: 50%;
        }
        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .nav-item:hover {
            background: var(--lagos-green);
            border-left-color: var(--lagos-yellow);
            color: var(--lagos-white);
            transform: translateX(5px);
        }
        .nav-item.active {
            background: var(--lagos-red);
            color: var(--lagos-white);
            font-weight: 600;
            border-left-color: var(--lagos-yellow);
        }
        .content-area {
            background: var(--lagos-white);
            border-radius: 15px;
            padding: 30px;
            overflow-y: auto;
            position: relative;
            border-top: 4px solid var(--lagos-blue);
        }
        .audit-form {
            max-width: 800px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-row.full {
            grid-template-columns: 1fr;
        }
        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-upload:hover {
            border-color: var(--lagos-blue);
            background: #e5e7eb;
        }
        .file-upload.dragover {
            border-color: var(--lagos-red);
            background: #fee2e2;
        }
        .uploaded-files {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .file-preview {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 1;
        }
        .file-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .file-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--lagos-red);
            color: var(--lagos-white);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            color: var(--lagos-white);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            position: relative;
            border: 3px solid var(--lagos-white);
        }
        .stat-card:nth-child(1) {
            background: var(--lagos-red);
        }
        .stat-card:nth-child(2) {
            background: var(--lagos-green);
        }
        .stat-card:nth-child(3) {
            background: var(--lagos-yellow);
            color: var(--lagos-navy);
        }
        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--lagos-blue);
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--lagos-white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table th {
            background: var(--lagos-blue);
            color: var(--lagos-white);
            font-weight: 600;
            position: relative;
        }
        .data-table th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--lagos-red);
        }
        .sync-status.synced {
            background: var(--lagos-green);
            color: var(--lagos-white);
            border: 1px solid var(--lagos-navy);
        }
        .sync-status.pending {
            background: var(--lagos-yellow);
            color: var(--lagos-navy);
            border: 1px solid var(--lagos-red);
        }
        .hidden {
            display: none !important;
        }
        .hamburger {
            display: none;
            flex-direction: column;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 16px;
            z-index: 1002;
        }
        .hamburger span {
            display: block;
            width: 28px;
            height: 4px;
            margin: 4px 0;
            background: var(--lagos-white);
            border-radius: 2px;
            transition: 0.3s;
        }
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
            .sidebar {
                display: none;
            }
            .mobile-sidebar {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 220px;
                height: 100vh;
                background: var(--lagos-navy);
                color: var(--lagos-white);
                padding: 40px 20px 20px 20px;
                z-index: 1001;
                border-right: 6px solid var(--lagos-red);
                box-shadow: 2px 0 16px rgba(0,0,0,0.15);
                transition: transform 0.3s;
            }
            .mobile-sidebar.hidden {
                display: none;
            }
            .main-content {
                grid-template-columns: 1fr;
            }

            /* Hide the header logout button on mobile */
@media (max-width: 768px) {
    .status .btn.btn-secondary {
        display: none !important;
    }
}
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Authentication Screen -->
        <div id="authScreen" class="auth-container">
            <h1 class="auth-title">Audit App Login</h1>
            
            <div class="credentials-info">
                <strong>Demo Credentials:</strong><br>
                Username: <code>admin</code> | Password: <code>password123</code><br>
                Username: <code>auditor</code> | Password: <code>audit2024</code>
            </div>
            
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            <button type="button" class="btn" onclick="login()">Login</button>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <div class="header">
                <div class="logo">
                    <img src="subeb.jpg" alt="Lagos State Logo">
                    Personnel & Facility Audit
                </div>
                <button class="hamburger" onclick="toggleMobileSidebar()" aria-label="Open navigation">
                    <span></span><span></span><span></span>
                </button>
                <div class="status">
                    <div id="connectionStatus" class="status-dot"></div>
                    <span id="connectionText">Online</span>
                    <button class="btn btn-secondary" style="width:auto;padding:8px 16px;margin-left:20px;" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <div class="nav-item active" onclick="showSection('dashboard')">📊 Dashboard</div>
                    <div class="nav-item" onclick="showSection('audit')">📝 New Audit</div>
                    <div class="nav-item" onclick="showSection('records')">📋 Records</div>
                    <div class="nav-item" onclick="showSection('sync')">🔄 Sync Data</div>
                </div>

                <div class="content-area">
                    <!-- Dashboard Section -->
                    <div id="dashboardSection" class="section">
                        <h2>Dashboard</h2>
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="totalAudits">0</div>
                                <div class="stat-label">Total Audits</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="pendingSync">0</div>
                                <div class="stat-label">Pending Sync</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="completedToday">0</div>
                                <div class="stat-label">Completed Today</div>
                            </div>
                        </div>

                        <h3>Recent Audits</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>School Name</th>
                                    <th>Local Government</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentAuditsTable">
                                <tr>
                                    <td colspan="4" style="text-align:center;padding:40px;color:#6b7280;">No audits completed yet</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Bulk Upload CSV -->
<div style="margin-bottom:20px;">
    <label for="csvUpload" style="font-weight:600;color:var(--lagos-navy);margin-right:10px;">Bulk Upload Audits (CSV):</label>
    <input type="file" id="csvUpload" accept=".csv" style="display:inline-block;width:auto;" onchange="handleCSVUpload(event)">
    <button class="btn btn-secondary" style="width:auto;padding:8px 16px;margin-left:10px;" onclick="triggerCSVInput()">Upload CSV</button>
    <span id="csvUploadMsg" style="margin-left:15px;font-size:14px;color:var(--lagos-red);"></span>
</div>

                    </div>

                    <!-- Audit Form Section -->
                    <div id="auditSection" class="section hidden">
                        <h2>New Personnel & Facility Audit</h2>
                        <form id="auditForm" class="audit-form" onsubmit="saveAudit(event)">
                            <div class="form-row"> <div class="form-group"> <label for="localGov">Local Government *</label> <select id="localGov" class="form-control" required onchange="loadSchools()"> <option value="">Select Local Government</option> </select> </div> <div class="form-group"> <label for="schoolName">Primary School *</label> <select id="schoolName" class="form-control" required disabled> <option value="">Select LGA first</option> </select> </div> </div>

                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="schoolAddress">School Address *</label>
                                    <textarea id="schoolAddress" class="form-control" rows="3" required></textarea>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="latitude">Latitude</label>
                                    <input type="number" id="latitude" class="form-control" step="any" readonly>
                                    <button type="button" class="location-btn" onclick="getLocation()">📍 Get Current Location</button>
                                </div>
                                <div class="form-group">
                                    <label for="longitude">Longitude</label>
                                    <input type="number" id="longitude" class="form-control" step="any" readonly>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="principalName">Principal Name</label>
                                    <input type="text" id="principalName" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="totalTeachers">Total Teachers</label>
                                    <input type="number" id="totalTeachers" class="form-control" min="0">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="totalStudents">Total Students</label>
                                    <input type="number" id="totalStudents" class="form-control" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="facilityCondition">Facility Condition</label>
                                    <select id="facilityCondition" class="form-control">
                                        <option value="">Select condition</option>
                                        <option value="excellent">Excellent</option>
                                        <option value="good">Good</option>
                                        <option value="fair">Fair</option>
                                        <option value="poor">Poor</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="additionalNotes">Additional Notes/Observations</label>
                                    <textarea id="additionalNotes" class="form-control" rows="4"></textarea>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Upload Photos (Max 5)</label>
                                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                                    <div>📸 Click to upload up to 5 photos or drag & drop</div>
                                    <div style="font-size:14px;color:#6b7280;margin-top:10px;">JPG, PNG files only</div>
                                </div>
                                <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" onchange="handleFiles(this.files)">
                                <div class="uploaded-files" id="uploadedFiles"></div>
                                <div id="photoLimitMsg" style="color:var(--lagos-red);font-size:13px;margin-top:8px;display:none;">You can only upload up to 5 photos.</div>
                            </div>

                            <button type="submit" class="btn">💾 Save Audit</button>
                        </form>
                    </div>

                    <!-- Records Section -->
                    <div id="recordsSection" class="section hidden">
                        <h2>Audit Records</h2>
                        <button class="btn" style="width:auto;margin-bottom:20px;" onclick="exportToCSV()">⬇️ Export to CSV</button>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>School Name</th>
                                    <th>Local Government</th>
                                    <th>Date</th>
                                    <th>Principal</th>
                                    <th>Teachers</th>
                                    <th>Students</th>
                                    <th>Sync Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTable">
                                <tr>
                                    <td colspan="8" style="text-align:center;padding:40px;color:#6b7280;">No records found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Sync Section -->
                    <div id="syncSection" class="section hidden">
                        <h2>Data Synchronization</h2>
                        <div style="background:#f0f9ff;padding:20px;border-radius:10px;margin-bottom:20px;">
                            <h3>Sync Status</h3>
                            <p>Pending sync: <span id="pendingSyncCount">0</span> records</p>
                            <button class="btn" style="width:auto;padding:12px 24px;margin-top:10px;" onclick="syncData()">🔄 Sync Now</button>
                        </div>
                        <div id="syncLog" style="background:#f9fafb;padding:20px;border-radius:10px;max-height:300px;overflow-y:auto;">
                            <p style="color:#6b7280;">Sync log will appear here...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add this mobile sidebar -->
            <div class="mobile-sidebar hidden" id="mobileSidebar">
                <div class="nav-item" onclick="showSection('dashboard');toggleMobileSidebar();">📊 Dashboard</div>
                <div class="nav-item" onclick="showSection('audit');toggleMobileSidebar();">📝 New Audit</div>
                <div class="nav-item" onclick="showSection('records');toggleMobileSidebar();">📋 Records</div>
                <div class="nav-item" onclick="showSection('sync');toggleMobileSidebar();">🔄 Sync Data</div>
                <button class="btn btn-secondary" style="margin-top:20px;" onclick="logout();toggleMobileSidebar();">Logout</button>
            </div>
        </div>
    </div>

    <script>

// Lagos State Local Government Areas and Primary Schools Data 
const lagosStateData = { "Agege": [ "Agege Primary School I", "Agege Primary School II", "Oko-Oba Primary School", "Mulero Primary School", "Pen Cinema Primary School", "Dopemu Primary School" ], "Ajeromi-Ifelodun": [ "Ajeromi Primary School", "Ifelodun Primary School I", "Ifelodun Primary School II", "Boundary Primary School", "Alakija Primary School", "Olodi Primary School" ], "Alimosho": [ "Alimosho Primary School I", "Alimosho Primary School II", "Idimu Primary School", "Ikotun Primary School", "Egbe Primary School", "Iyana Ipaja Primary School" ], "Amuwo-Odofin": [ "Amuwo-Odofin Primary School", "Festac Primary School I", "Festac Primary School II", "Trade Fair Primary School", "Mile 2 Primary School", "Kirikiri Primary School" ], "Apapa": [ "Apapa Primary School I", "Apapa Primary School II", "Liverpool Primary School", "Creek Road Primary School", "Point Road Primary School", "Warehouse Primary School" ], "Badagry": [ "Badagry Primary School I", "Badagry Primary School II", "Ajara Primary School", "Iworo Primary School", "Koga Primary School", "Topo Primary School" ], "Epe": [ "Epe Primary School I", "Epe Primary School II", "Ejinrin Primary School", "Noforija Primary School", "Lekki Primary School", "Orimedu Primary School" ], "Eti-Osa": [ "Victoria Island Primary School", "Ikoyi Primary School", "Lekki Phase I Primary School", "Ajah Primary School", "Eti-Osa Primary School", "Ilasan Primary School" ], "Ibeju-Lekki": [ "Ibeju Primary School", "Lekki Primary School", "Akodo Primary School", "Elemoro Primary School", "Bogije Primary School", "Eleko Primary School" ], "Ifako-Ijaiye": [ "Ifako Primary School", "Ijaiye Primary School I", "Ijaiye Primary School II", "Alakuko Primary School", "Ojokoro Primary School", "Agbado Primary School" ], "Ikeja": [ "Ikeja Primary School I", "Ikeja Primary School II", "GRA Primary School", "Maryland Primary School", "Alausa Primary School", "Computer Village Primary School" ], "Ikorodu": [ "Ikorodu Primary School I", "Ikorodu Primary School II", "Igbogbo Primary School", "Bayeku Primary School", "Ijede Primary School", "Imota Primary School" ], "Kosofe": [ "Kosofe Primary School", "Ketu Primary School I", "Ketu Primary School II", "Mile 12 Primary School", "Owode Primary School", "Agboyi Primary School" ], "Lagos Island": [ "Lagos Island Primary School I", "Lagos Island Primary School II", "Tafawa Balewa Primary School", "Campos Primary School", "Oke-Arin Primary School", "Marina Primary School" ], "Lagos Mainland": [ "Lagos Mainland Primary School", "Yaba Primary School I", "Yaba Primary School II", "Ebute-Metta Primary School", "Oyingbo Primary School", "Sabo Primary School" ], "Mushin": [ "Mushin Primary School I", "Mushin Primary School II", "Papa Ajao Primary School", "Isolo Primary School", "Idi-Oro Primary School", "Oke-Afa Primary School" ], "Ojo": [ "Ojo Primary School I", "Ojo Primary School II", "Alaba Primary School", "Okokomaiko Primary School", "Shibiri Primary School", "Igando Primary School" ], "Oshodi-Isolo": [ "Oshodi Primary School I", "Oshodi Primary School II", "Isolo Primary School I", "Isolo Primary School II", "Mafoluku Primary School", "Bolade Primary School" ], "Shomolu": [ "Shomolu Primary School I", "Shomolu Primary School II", "Bariga Primary School", "Pedro Primary School", "Akoka Primary School", "Gbagada Primary School" ], "Surulere": [ "Surulere Primary School I", "Surulere Primary School II", "Itire Primary School", "Lawanson Primary School", "Aguda Primary School", "Adelabu Primary School" ] };

        // Global variables
        let currentUser = null;
        let auditData = [];
        let uploadedFiles = [];
        let isOnline = navigator.onLine;
        
        // Replace the existing window.onload function
window.onload = function() {
    console.log('App initialized');
    loadData();
    loadSession(); // Add this line
    loadLocalGovernments();
    updateDashboard();
    updateConnectionStatus();
    loadFromServer(); // Add this line

};


// Add this new function to load saved session
function loadSession() {
    try {
        const savedUser = localStorage.getItem('auditAppCurrentUser');
        if (savedUser) {
            currentUser = savedUser;
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            console.log('Session restored for user:', currentUser);
        }
    } catch (e) {
        console.error('Error loading session:', e);
    }
}


       function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    
    console.log('Login attempt:', username, password);
    
    if ((username === 'admin' && password === 'password123') || 
        (username === 'auditor' && password === 'audit2024')) {
        
        currentUser = username;
        // Save session to localStorage
        localStorage.setItem('auditAppCurrentUser', username);
        
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        console.log('Login successful');
        loadFromServer(); 
    } else {
        alert('Invalid credentials!\n\nValid login credentials:\n• admin / password123\n• auditor / audit2024');
        console.log('Login failed');
    }
}
        
// Modify the existing logout function (replace the existing one)
function logout() {
    currentUser = null;
    // Remove session from localStorage
    localStorage.removeItem('auditAppCurrentUser');
    
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';

}

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Update navigation
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            if (sectionName === 'dashboard') updateDashboard(); // <-- Add this line
    if (sectionName === 'records') loadRecords();
    if (sectionName === 'sync') updateSyncSection();
        }

        // Get current location
        function getLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    document.getElementById('latitude').value = position.coords.latitude;
                    document.getElementById('longitude').value = position.coords.longitude;
                    alert('Location captured successfully!');
                },
                function(error) {
                    alert('Error getting location: ' + error.message);
                }
            );
        }


// Resize image to max width/height before saving as base64
function resizeImage(file, maxSize = 400, quality = 0.4) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;
                if (width > height) {
                    if (width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                // Use JPEG for better compression, fallback to PNG
                let mimeType = file.type === "image/png" ? "image/png" : "image/jpeg";
                resolve(canvas.toDataURL(mimeType, quality));
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

        // Handle file uploads
     // Handle file uploads
function handleFiles(files) {
    const maxPhotos = 5;
    let filesToAdd = Array.from(files);
    if (uploadedFiles.length + filesToAdd.length > maxPhotos) {
        filesToAdd = filesToAdd.slice(0, maxPhotos - uploadedFiles.length);
        document.getElementById('photoLimitMsg').style.display = 'block';
    } else {
        document.getElementById('photoLimitMsg').style.display = 'none';
    }
    let resizePromises = [];
    for (let i = 0; i < filesToAdd.length; i++) {
        const file = filesToAdd[i];
        if (file.type.startsWith('image/')) {
            // Resize before saving
            const p = resizeImage(file).then(resizedDataUrl => {
                uploadedFiles.push({
                    name: file.name,
                    data: resizedDataUrl,
           
                    type: file.type
                });
                displayFile(file.name, resizedDataUrl);
            });
            resizePromises.push(p);
        }
    }
    Promise.all(resizePromises).then(updateFileDisplay);
}

        // Add this anywhere in your <script> tag
function toggleMobileSidebar() {
    const sidebar = document.getElementById('mobileSidebar');
    if (sidebar) {
        sidebar.classList.toggle('hidden');
    }
}
        function displayFile(name, dataUrl) {
            const container = document.getElementById('uploadedFiles');
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-preview';
            // Add a download button for the image
            fileDiv.innerHTML = `
                <img src="${dataUrl}" alt="${name}">
                <button class="file-remove" onclick="removeFile('${name}')">×</button>
                <a href="${dataUrl}" download="${name}" class="file-download" title="Download"><span style="font-size:18px;position:absolute;bottom:5px;right:5px;background:rgba(30,64,175,0.8);color:#fff;padding:2px 8px;border-radius:6px;">⬇️</span></a>
            `;
            container.appendChild(fileDiv);
        }
        function removeFile(name) {
            uploadedFiles = uploadedFiles.filter(file => file.name !== name);
            updateFileDisplay();
            if (uploadedFiles.length < 5) {
                document.getElementById('photoLimitMsg').style.display = 'none';
            }
        }
        function updateFileDisplay() {
            const container = document.getElementById('uploadedFiles');
            container.innerHTML = '';
            uploadedFiles.forEach(file => {
                displayFile(file.name, file.data);
            });
            if (uploadedFiles.length >= 5) {
                document.getElementById('fileInput').disabled = true;
            } else {
                document.getElementById('fileInput').disabled = false;
            }
        }

 // Load Local Government Areas into dropdown 
 function loadLocalGovernments() {
    const localGovDropdown = document.getElementById('localGov');
    const lgas = Object.keys(lagosStateData).sort();
    localGovDropdown.innerHTML = '<option value="">Select Local Government</option>';
    lgas.forEach(lga => {
        const option = document.createElement('option');
        option.value = lga;
        option.textContent = lga;
        localGovDropdown.appendChild(option);
    });
}

// Load schools based on selected LGA 
function loadSchools() {
    const localGov = document.getElementById('localGov').value;
    const schoolDropdown = document.getElementById('schoolName');
    schoolDropdown.innerHTML = '<option value="">Select Primary School</option>';
    if (!localGov) {
        schoolDropdown.disabled = true;
        schoolDropdown.innerHTML = '<option value="">Select LGA first</option>';
        return;
    }
    schoolDropdown.disabled = false;
    const schools = lagosStateData[localGov] || [];
    schools.forEach(school => {
        const option = document.createElement('option');
        option.value = school;
        option.textContent = school;
        schoolDropdown.appendChild(option);
    });
}


        // Save audit
       // Replace the existing saveAudit function with this enhanced version
async function saveAudit(event) {
    event.preventDefault();
    if (uploadedFiles.length > 5) {
        alert('You can only upload up to 5 photos.');
        return;
    }
    const form = document.getElementById('auditForm');
    const editId = form.getAttribute('data-edit-id');
    let audit;
    // Upload images to backend first
    const photoNames = [];
    for (const file of uploadedFiles) {
        if (file.data && file.name) {
            // Upload to backend if not already uploaded
            await fetch('/api/photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name, data: file.data, type: file.type || 'image/jpeg' })
            });
            photoNames.push(file.name);
        }
    }
    if (editId) {
        // Edit mode: update existing audit
        const idx = auditData.findIndex(a => a.id == editId);
        if (idx === -1) return alert('Audit not found.');
        audit = auditData[idx];
        audit.schoolName = document.getElementById('schoolName').value;
        audit.localGov = document.getElementById('localGov').value;
        audit.schoolAddress = document.getElementById('schoolAddress').value;
        audit.latitude = parseFloat(document.getElementById('latitude').value) || null;
        audit.longitude = parseFloat(document.getElementById('longitude').value) || null;
        audit.principalName = document.getElementById('principalName').value;
        audit.totalTeachers = parseInt(document.getElementById('totalTeachers').value) || 0;
        audit.totalStudents = parseInt(document.getElementById('totalStudents').value) || 0;
        audit.facilityCondition = document.getElementById('facilityCondition').value;
        audit.additionalNotes = document.getElementById('additionalNotes').value;
        audit.photos = [...photoNames];
        audit.synced = false; // Mark as not synced after edit
        audit.timestamp = new Date().toISOString();
    } else {
        // New audit
        audit = {
            id: Date.now(),
            schoolName: document.getElementById('schoolName').value,
            localGov: document.getElementById('localGov').value,
            schoolAddress: document.getElementById('schoolAddress').value,
            latitude: parseFloat(document.getElementById('latitude').value) || null,
            longitude: parseFloat(document.getElementById('longitude').value) || null,
            principalName: document.getElementById('principalName').value,
            totalTeachers: parseInt(document.getElementById('totalTeachers').value) || 0,
            totalStudents: parseInt(document.getElementById('totalStudents').value) || 0,
            facilityCondition: document.getElementById('facilityCondition').value,
            additionalNotes: document.getElementById('additionalNotes').value,
            photos: [...photoNames],
            auditor: currentUser,
            timestamp: new Date().toISOString(),
            synced: false
        };
        auditData.push(audit);
    }

    saveData();
    updateDashboard();
    loadRecords();

    // Reset edit mode
    form.removeAttribute('data-edit-id');

    alert('Audit saved successfully!');
    // Reset form
    event.target.reset();
    uploadedFiles = [];
    document.getElementById('uploadedFiles').innerHTML = '';
    document.getElementById('localGov').value = '';
    document.getElementById('schoolName').innerHTML = '<option value="">Select LGA first</option>';
    document.getElementById('schoolName').disabled = true;
    updateDashboard();
    document.querySelector('#auditForm button[type="submit"]').textContent = "💾 Save Audit";
}

// Updated syncToServer function
async function syncToServer(audit) {
    try {
        // Ensure photos is array of strings
        const auditToSend = { ...audit, photos: Array.isArray(audit.photos) ? audit.photos.map(f => typeof f === 'string' ? f : f.name) : [] };
        const response = await fetch('/api/audits', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(auditToSend)
        });
        
        if (response.ok) {
            // Mark as synced in local storage
            const index = auditData.findIndex(audit => audit.id === audit.id);
            if (index !== -1) {
                auditData[index].synced = true;
                saveData();  // Save updated sync status
                updateDashboard();  // Update sync indicators
            }
            console.log('Audit synced to server successfully');
        }
    } catch (error) {
        console.error('Error syncing to server:', error);
        throw error;  // Re-throw for .catch() handler
    }
}

// New function to reload all data
async function reloadAllData() {
    try {
        const response = await fetch('/api/audits');
        const serverData = await response.json();
        
        // Replace local data completely with server data
        auditData = serverData;
        updateDashboard();
        
        console.log('Reloaded', auditData.length, 'records from server');
    } catch (error) {
        console.error('Error reloading data:', error);
    }
}

              // Data management
        function saveData() {
            try {
                const dataToSave = JSON.stringify(auditData);
                localStorage.setItem('auditAppData', dataToSave);
                console.log('Data saved:', auditData.length + ' records');
            } catch (e) {
                console.error('Error saving data:', e);
                alert('Error saving data. Please try again.');
            }
        }

        function loadData() {
            try {
                const savedData = localStorage.getItem('auditAppData');
                if (savedData) {
                    auditData = JSON.parse(savedData);
                    console.log('Data loaded:', auditData.length + ' records');
                } else {
                    auditData = [];
                    console.log('No saved data found, starting fresh');
                }
            } catch (e) {
                console.error('Error loading data:', e);
                auditData = [];
                alert('Error loading saved data. Starting with empty records.');
            }
        }
        // Dashboard updates
        function updateDashboard() {
    const totalAudits = auditData.length;
    const pendingSync = auditData.filter(audit => !audit.synced).length;
    const today = new Date().toDateString();
    const completedToday = auditData.filter(audit => 
        new Date(audit.timestamp).toDateString() === today
    ).length;
    
    console.log('updateDashboard called - totalAudits:', totalAudits);
    
    document.getElementById('totalAudits').textContent = totalAudits;
    document.getElementById('pendingSync').textContent = pendingSync;
    document.getElementById('completedToday').textContent = completedToday;
    updateRecentAuditsTable();
}

        function updateRecentAuditsTable() {
            const tableBody = document.getElementById('recentAuditsTable');
            if (auditData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:#6b7280;">No audits completed yet</td></tr>';
            } else {
                const recentAudits = auditData.slice(-5).reverse();
                tableBody.innerHTML = recentAudits.map(audit => `
                    <tr>
                        <td>${audit.schoolName}</td>
                        <td>${audit.localGov}</td>
                        <td>${new Date(audit.timestamp).toLocaleDateString()}</td>
                        <td><span class="sync-status ${audit.synced ? 'synced' : 'pending'}">${audit.synced ? 'Synced' : 'Pending'}</span></td>
                    </tr>
                `).join('');
            }
        }

       function loadRecords() {
    const tableBody = document.getElementById('recordsTable');
    if (auditData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:#6b7280;">No records found</td></tr>';
    } else {
        tableBody.innerHTML = auditData.map((audit, idx) => `
            <tr>
                <td>${audit.schoolName}</td>
                <td>${audit.localGov}</td>
                <td>${new Date(audit.timestamp).toLocaleDateString()}</td>
                <td>${audit.principalName || '-'}</td>
                <td>${audit.totalTeachers}</td>
                <td>${audit.totalStudents}</td>
                <td><span class="sync-status ${audit.synced ? 'synced' : 'pending'}">${audit.synced ? 'Synced' : 'Pending'}</span></td>
                <td>
                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:13px;" onclick="(async () => { await editRecord(${audit.id}); })()">Edit</button>
                    <button class="btn btn-secondary" style="padding:4px 10px;font-size:13px;" onclick="deleteRecord(${audit.id})">Delete</button>
                </td>
            </tr>
        `).join('');
    }
}



async function editRecord(auditId) {
    const audit = auditData.find(a => a.id === auditId);
    if (!audit) return alert('Audit not found.');

    // Show the audit form section
    showSection('audit');

    // Fill the form fields
    document.getElementById('localGov').value = audit.localGov;
    loadSchools();
    document.getElementById('schoolName').value = audit.schoolName;
    document.getElementById('schoolAddress').value = audit.schoolAddress;
    document.getElementById('latitude').value = audit.latitude || '';
    document.getElementById('longitude').value = audit.longitude || '';
    document.getElementById('principalName').value = audit.principalName || '';
    document.getElementById('totalTeachers').value = audit.totalTeachers || '';
    document.getElementById('totalStudents').value = audit.totalStudents || '';
    document.getElementById('facilityCondition').value = audit.facilityCondition || '';
    document.getElementById('additionalNotes').value = audit.additionalNotes || '';

    // Load photos from backend
    uploadedFiles = audit.photos && audit.photos.length
        ? await fetchImageDataForFilenames(audit.photos)
        : [];
    updateFileDisplay();

    // Store the id of the audit being edited
    document.getElementById('auditForm').setAttribute('data-edit-id', auditId);
    document.querySelector('#auditForm button[type="submit"]').textContent = "Update Audit";
}

// Helper: fetch image data from backend for each filename
async function fetchImageDataForFilenames(filenames) {
    const files = [];
    for (const name of filenames) {
        try {
            const res = await fetch(`/api/photo/${encodeURIComponent(name)}`);
            if (!res.ok) throw new Error('Not found');
            const blob = await res.blob();
            const dataUrl = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
            files.push({ name, data: dataUrl, type: blob.type });
        } catch (e) {
            // If not found, just push with empty data
            files.push({ name, data: '', type: '' });
        }
    }
    return files;
}

        function updateSyncSection() {
            const pendingCount = auditData.filter(audit => !audit.synced).length;
            document.getElementById('pendingSyncCount').textContent = pendingCount;
        }

        async function syncData() {
    const unsyncedRecords = auditData.filter(audit => !audit.synced);
    
    if (unsyncedRecords.length === 0) {
        document.getElementById('syncLog').innerHTML = '<p style="color:#10b981;">✅ All records are already synced!</p>';
        return;
    }

    if (!isOnline) {
        document.getElementById('syncLog').innerHTML = '<p style="color:#ef4444;">❌ Cannot sync: No internet connection</p>';
        return;
    }

    // Show syncing message
    document.getElementById('syncLog').innerHTML = '<p style="color:#0ea5e9;">🔄 Syncing ' + unsyncedRecords.length + ' records...</p>';
    
    try {
        const response = await fetch('/api/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ audits: unsyncedRecords })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Mark all records as synced
            auditData.forEach(audit => {
                if (!audit.synced) audit.synced = true;
            });
            
            saveData();
            updateDashboard();
            updateSyncSection();
            
            document.getElementById('syncLog').innerHTML = `<p style="color:#10b981;">✅ ${result.message}</p>`;
        } else {
            throw new Error('Sync failed');
        }
    } catch (error) {
        console.error('Error syncing data:', error);
        document.getElementById('syncLog').innerHTML = '<p style="color:#ef4444;">❌ Sync failed. Please try again.</p>';
    }
}

async function loadFromServer() {
    if (!isOnline) return;
    try {
        const response = await fetch('/api/audits');
        if (response.ok) {
            const serverData = await response.json();
            // Replace local data completely with server data
            auditData = serverData;
            saveData();
            updateDashboard();
            console.log(`Loaded ${auditData.length} records from server`);
        }
    } catch (error) {
        console.error('Error loading from server:', error);
    }
}







        function updateConnectionStatus() {
            const statusDot = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            if (isOnline) {
                statusDot.classList.remove('offline');
                statusText.textContent = 'Online';
            } else {
                statusDot.classList.add('offline');
                statusText.textContent = 'Offline';
            }
        }

        // Online/offline detection
        window.addEventListener('online', function() {
            isOnline = true;
            updateConnectionStatus();
        });

        window.addEventListener('offline', function() {
            isOnline = false;
            updateConnectionStatus();
        });

        // Allow Enter key to submit login
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('authScreen').classList.contains('hidden')) {
                login();
            }
        });

        function exportToCSV() {
    if (!auditData.length) {
        alert('No records to export.');
        return;
    }
    const header = [
        'School Name',
        'Local Government',
        'Date',
        'Principal',
        'Teachers',
        'Students',
        'Facility Condition',
        'Additional Notes',
        'Latitude',
        'Longitude',
        'Auditor',
        'Sync Status',
        'Photos'
    ];
    const rows = auditData.map(audit => [
        audit.schoolName,
        audit.localGov,
        new Date(audit.timestamp).toLocaleString(),
        audit.principalName || '',
        audit.totalTeachers,
        audit.totalStudents,
        audit.facilityCondition || '',
        audit.additionalNotes ? audit.additionalNotes.replace(/\n/g, ' ') : '',
        audit.latitude || '',
        audit.longitude || '',
        audit.auditor || '',
        audit.synced ? 'Synced' : 'Pending',
        (audit.photos && audit.photos.length) ? audit.photos.map(p => p.name).join('; ') : ''
    ]);
    let csvContent = '';
    csvContent += header.join(',') + '\r\n';
    rows.forEach(row => {
        csvContent += row.map(field => '"' + String(field).replace(/"/g, '""') + '"').join(',') + '\r\n';
    });
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', 'audit_records.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function deleteRecord(auditId) {
    if (!confirm('Are you sure you want to delete this record?')) return;
    auditData = auditData.filter(audit => audit.id !== auditId);
    saveData();
    updateDashboard();
    loadRecords();
}

// Bulk CSV upload functions
function triggerCSVInput() {
    document.getElementById('csvUpload').click();
}

function handleCSVUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!file.name.endsWith('.csv')) {
        document.getElementById('csvUploadMsg').textContent = 'Please select a valid CSV file.';
        return;
    }
    const reader = new FileReader();
    reader.onload = async function(e) {
        const text = e.target.result;
        const result = parseCSV(text);
        if (result.error) {
            document.getElementById('csvUploadMsg').textContent = result.error;
            return;
        }
        // Build new LGA->Schools mapping from CSV
        const csvLgaSchools = {};
        result.data.forEach(row => {
            // Flexible header matching
            const getAny = (...keys) => {
                for (const k of keys) {
                    for (const header of Object.keys(row)) {
                        if (header.replace(/\s|_/g, '').toLowerCase() === k.replace(/\s|_/g, '').toLowerCase()) {
                            return (row[header] !== undefined && row[header] !== null) ? String(row[header]).trim() : '';
                        }
                    }
                }
                return '';
            };
            const lga = getAny('Local Government');
            const school = getAny('School Name');
            if (!lga || !school) return;
            if (!csvLgaSchools[lga]) csvLgaSchools[lga] = new Set();
            csvLgaSchools[lga].add(school);
        });
        // Convert sets to sorted arrays
        Object.keys(csvLgaSchools).forEach(lga => {
            csvLgaSchools[lga] = Array.from(csvLgaSchools[lga]).sort();
        });
        // Overwrite global lagosStateData with only imported data
        for (const key in lagosStateData) delete lagosStateData[key];
        Object.assign(lagosStateData, csvLgaSchools);
        // Update dropdowns
        loadLocalGovernments();
        document.getElementById('schoolName').innerHTML = '<option value="">Select LGA first</option>';
        document.getElementById('schoolName').disabled = true;
        document.getElementById('csvUploadMsg').style.color = 'var(--lagos-green)';
        document.getElementById('csvUploadMsg').textContent = `Imported ${Object.keys(csvLgaSchools).length} LGAs from CSV.`;
        setTimeout(()=>{document.getElementById('csvUploadMsg').textContent='';}, 4000);
    };
    reader.readAsText(file);
}

function parseCSV(text) {
    // Simple CSV parser (handles commas, quoted fields, newlines)
    const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
    if (lines.length < 2) return { error: 'CSV must have a header and at least one row.' };
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const row = {};
        let inQuotes = false, field = '', col = 0, chars = lines[i].split('');
        for (let j = 0; j < chars.length; j++) {
            const c = chars[j];
            if (c === '"') {
                if (inQuotes && chars[j+1] === '"') { field += '"'; j++; }
                else inQuotes = !inQuotes;
            } else if (c === ',' && !inQuotes) {
                row[headers[col++]] = field;
                field = '';
            } else {
                field += c;
            }
        }
        row[headers[col]] = field;
        data.push(row);
    }
    return { data };
}
    </script>
</body>
</html>