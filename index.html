<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --lagos-red: #DC2626;
            --lagos-blue: #1E40AF;
            --lagos-yellow: #FACC15;
            --lagos-green: #16A34A;
            --lagos-white: #FFFFFF;
            --lagos-navy: #1E3A8A;
            --lagos-dark-gray: #64748B;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--lagos-blue);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: var(--lagos-navy);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--lagos-white);
            position: relative;
            border-left: 8px solid var(--lagos-red);
        }

        .header .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--lagos-white);
        }
        .header .logo img {
            height: 40px;
            width: 40px;
            margin-right: 12px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--lagos-green);
            box-shadow: 0 0 10px rgba(22, 163, 74, 0.5);
            border: 2px solid var(--lagos-white);
        }
        .status-dot.offline {
            background: var(--lagos-red);
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }

        .auth-container {
            background: var(--lagos-white);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 4px solid var(--lagos-blue);
            position: relative;
        }
        .auth-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--lagos-navy);
            font-size: 28px;
            position: relative;
            padding-left: 0;
        }
        .auth-title::after {
            content: 'Centre of Excellence';
            display: block;
            font-size: 12px;
            color: var(--lagos-blue);
            font-weight: normal;
            margin-top: 5px;
            font-style: italic;
        }
        .credentials-info {
            background: var(--lagos-yellow);
            border: 2px solid var(--lagos-green);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--lagos-navy);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--lagos-navy);
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--lagos-blue);
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        .btn {
            width: 100%;
            padding: 14px;
            background: var(--lagos-blue);
            color: var(--lagos-white);
            border: 2px solid var(--lagos-red);
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: var(--lagos-red);
            border-color: var(--lagos-blue);
            color: var(--lagos-white);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-secondary {
            background: var(--lagos-green);
            border-color: var(--lagos-yellow);
            color: var(--lagos-white);
        }
        .btn-secondary:hover {
            background: var(--lagos-yellow);
            border-color: var(--lagos-green);
            color: var(--lagos-navy);
        }
        .location-btn {
            background: var(--lagos-green);
            color: var(--lagos-white);
            border: 2px solid var(--lagos-yellow);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        .location-btn:hover {
            background: var(--lagos-yellow);
            border-color: var(--lagos-green);
            color: var(--lagos-navy);
            transform: translateY(-1px);
        }
        .main-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            height: calc(100vh - 140px);
            position: relative;
        }
        .sidebar {
            background: var(--lagos-navy);
            border-radius: 15px;
            padding: 20px;
            color: var(--lagos-white);
            position: relative;
            border-left: 6px solid var(--lagos-red);
        }
        .sidebar::after {
           
            position: absolute;
            top: 20px;
            right: 20px;
            width: 20px;
            height: 20px;
            background: var(--lagos-yellow);
            border-radius: 50%;
        }
        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .nav-item:hover {
            background: var(--lagos-green);
            border-left-color: var(--lagos-yellow);
            color: var(--lagos-white);
            transform: translateX(5px);
        }
        .nav-item.active {
            background: var(--lagos-red);
            color: var(--lagos-white);
            font-weight: 600;
            border-left-color: var(--lagos-yellow);
        }
        .content-area {
            background: var(--lagos-white);
            border-radius: 15px;
            padding: 30px;
            overflow-y: auto;
            position: relative;
            border-top: 4px solid var(--lagos-blue);
        }
        .audit-form {
            max-width: 800px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-row.full {
            grid-template-columns: 1fr;
        }
        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-upload:hover {
            border-color: var(--lagos-blue);
            background: #e5e7eb;
        }
        .file-upload.dragover {
            border-color: var(--lagos-red);
            background: #fee2e2;
        }
        .uploaded-files {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .file-preview {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 1;
        }
        .file-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .file-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--lagos-red);
            color: var(--lagos-white);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            color: var(--lagos-white);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            position: relative;
            border: 3px solid var(--lagos-white);
        }
        .stat-card:nth-child(1) {
            background: var(--lagos-red);
        }
        .stat-card:nth-child(2) {
            background: var(--lagos-green);
        }
        .stat-card:nth-child(3) {
            background: var(--lagos-yellow);
            color: var(--lagos-navy);
        }
        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--lagos-blue);
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--lagos-white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table th {
            background: var(--lagos-blue);
            color: var(--lagos-white);
            font-weight: 600;
            position: relative;
        }
        .data-table th::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--lagos-red);
        }
        .sync-status.synced {
            background: var(--lagos-green);
            color: var(--lagos-white);
            border: 1px solid var(--lagos-navy);
        }
        .sync-status.pending {
            background: var(--lagos-yellow);
            color: var(--lagos-navy);
            border: 1px solid var(--lagos-red);
        }
        .hidden {
            display: none !important;
        }
        .hamburger {
            display: none;
            flex-direction: column;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 16px;
            z-index: 1002;
        }
        .hamburger span {
            display: block;
            width: 28px;
            height: 4px;
            margin: 4px 0;
            background: var(--lagos-white);
            border-radius: 2px;
            transition: 0.3s;
        }
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
            .sidebar {
                display: none;
            }
            .mobile-sidebar {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 220px;
                height: 100vh;
                background: var(--lagos-navy);
                color: var(--lagos-white);
                padding: 40px 20px 20px 20px;
                z-index: 1001;
                border-right: 6px solid var(--lagos-red);
                box-shadow: 2px 0 16px rgba(0,0,0,0.15);
                transition: transform 0.3s;
            }
            .mobile-sidebar.hidden {
                display: none;
            }
            .main-content {
                grid-template-columns: 1fr;
            }
.lagos-header {
  background: linear-gradient(90deg, var(--lagos-yellow) 0%, var(--lagos-green) 100%);
  border-radius: 12px;
  padding: 12px 24px;
  box-shadow: 0 2px 12px rgba(30,64,175,0.08);
  margin-bottom: 24px;
}
.section h2 {
  color: var(--lagos-red);
  font-weight: 700;
  letter-spacing: 0.5px;
  margin-bottom: 18px;
  text-align: center;
  background: linear-gradient(90deg, var(--lagos-yellow) 0%, var(--lagos-green) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
footer {
  margin-top: 40px;
  background: var(--lagos-navy);
  color: var(--lagos-yellow);
  border-top: 4px solid var(--lagos-green);
  font-size: 1rem;
  letter-spacing: 0.5px;
}
.btn, .btn-secondary, .location-btn {
  font-family: inherit;
  font-weight: 600;
  border-radius: 10px;
  border-width: 2px;
  box-shadow: 0 2px 8px rgba(30,64,175,0.08);
}
.survey-card {
  border-width: 4px;
  border-color: var(--lagos-blue);
  background: linear-gradient(120deg, var(--lagos-yellow) 0%, var(--lagos-white) 100%);
}
.survey-card:hover {
  border-color: var(--lagos-green);
  background: linear-gradient(120deg, var(--lagos-green) 0%, var(--lagos-yellow) 100%);
}
.btn {
  background: var(--lagos-blue);
  color: var(--lagos-white);
  border-color: var(--lagos-red);
}
.btn:hover {
  background: var(--lagos-red);
  border-color: var(--lagos-blue);
  color: var(--lagos-white);
}
.btn-secondary {
  background: var(--lagos-green);
  border-color: var(--lagos-yellow);
  color: var(--lagos-white);
}
.btn-secondary:hover {
  background: var(--lagos-yellow);
  border-color: var(--lagos-green);
  color: var(--lagos-navy);
}
.section {
  background: var(--lagos-white);
  border-radius: 18px;
  box-shadow: 0 4px 24px rgba(30,64,175,0.10);
  padding: 32px 18px 24px 18px;
  margin-bottom: 32px;
}


/* Landing Page Layout */
#landingPage {
    display: flex;
    align-items: flex-start; /* Align items to the top */
    gap: 20px; /* Space between logo and content */
}

.landing-page-logo {
    flex-shrink: 0; /* Prevent logo from shrinking */
    max-width: 120px; /* Adjust size as needed */
    height: auto;
    border-radius: 8px;
    border: 2px solid var(--lagos-yellow);
    background: var(--lagos-white);
    padding: 5px;
}

.landing-page-content {
    flex-grow: 1; /* Content takes remaining space */
}

/* Responsive adjustments for Landing Page */
@media (max-width: 768px) { /* Adjust breakpoint as needed */
    #landingPage {
        flex-direction: column;
        align-items: center; /* Center items when stacked */
    }

    .landing-page-logo {
        margin-bottom: 20px; /* Space below logo when stacked */
        max-width: 100px; /* Slightly smaller logo for mobile stacking */
    }

    /* Ensure the h1 title within landing-page-content is also centered on mobile */
    /* The h1 already has inline text-align:center, this is a fallback/override if that changes */
    #landingPage .landing-page-content h1 {
         text-align: center !important;
    }
}

/* Lagos State form field branding and white text */
.section {
  background: var(--lagos-blue);
  color: var(--lagos-white);
}
.form-group label {
  color: var(--lagos-yellow) !important;
  font-weight: 600;
}
.form-control,
.form-control:focus,
select.form-control,
textarea.form-control {
  background: rgba(30,64,175,0.85) !important; /* Lagos blue, slightly transparent */
  color: var(--lagos-white) !important;
  border: 2px solid var(--lagos-yellow) !important;
  border-radius: 10px;
  font-size: 16px;
  transition: all 0.3s;
}
.form-control:focus {
  border-color: var(--lagos-green) !important;
  box-shadow: 0 0 0 3px rgba(250,204,21,0.15);
}
input::placeholder, textarea::placeholder {
  color: #e5e5e5 !important;
  opacity: 1;
}
select.form-control option {
  color: var(--lagos-navy);
  background: var(--lagos-yellow);
}
.audit-form {
  color: var(--lagos-white);
}

            /* Hide the header logout button on mobile */
@media (max-width: 768px) {
    .status .btn.btn-secondary {
        display: none !important;
    }
}
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Landing Page: Four Survey Cards -->
        <div id="landingPage" class="section">
            <img src="subeb.jpg" alt="LASUBEB Logo" class="landing-page-logo">
            <div class="landing-page-content">
                <h1 style="text-align:center;margin-bottom:32px;color:var(--lagos-navy);font-size:2.2rem;">Welcome to LASUBEB/PIMU Needs Assessment Portal</h1>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:32px;max-width:900px;margin:0 auto;">
                    <div class="survey-card" onclick="showSurvey('silnat')">
                    <h2>School Infrastructure & Leadership<br>(SILNAT)</h2>
                    <p>For Head Teachers/Managers</p>
                </div>
                <div class="survey-card" onclick="showSurvey('tcmats')">
                    <h2>Teachers Classroom Management & Teaching<br>(TCMATS)</h2>
                    <p>For Teachers</p>
                </div>
                <div class="survey-card" onclick="showSurvey('lori')">
                    <h2>Lesson Observation Rating<br>(LORI)</h2>
                    <p>For Assessors</p>
                </div>
                <div class="survey-card" onclick="showSurvey('voices')">
                    <h2>Learner Voices/Opinions<br>(VOICES)</h2>
                    <p>For Learners</p>
                </div>
            </div>
            </div> <!-- Closing div for landing-page-content -->
        </div>

        <!-- Survey Sections (initially hidden) -->
        <div id="silnatSection" class="section hidden">
            <button class="btn btn-secondary" style="width:auto;margin-bottom:20px;" onclick="backToLanding()">← Back to Home</button>
            <div class="lagos-header" style="display:flex;align-items:center;gap:16px;justify-content:center;margin-bottom:24px;">
  <img src="subeb.jpg" alt="Lagos State Logo" style="height:48px;width:48px;border-radius:8px;border:3px solid var(--lagos-yellow);background:var(--lagos-white);box-shadow:0 2px 8px rgba(30,64,175,0.10);">
  <div style="font-size:1.6rem;font-weight:700;color:var(--lagos-blue);letter-spacing:1px;">Lagos State Universal Basic Education Board (LASUBEB)</div>
</div>
            <h2>School Infrastructure & Leadership Needs Assessment Tool (SILNAT)</h2>
            <!-- Place this block right after the <h2> in #silnatSection, before the <form id="silnatForm"...> -->
<div class="intro-card" style="background:rgb(243, 242, 240);border-left:6px solid var(--lagos-yellow);border-radius:12px;padding:22px 20px 18px 20px;margin-bottom:28px;color:var(--lagos-navy);font-size:1.08rem;line-height:1.7;">
    <strong>Dear Respondent,</strong><br><br>
    This instrument is designed to elicit responses that are capable of helping the Board of LASUBEB and PIMU to identify areas of Education Managers’ needs with the intention of helping them overcome difficulties in the course of discharging their duties. The instrument is not meant for any other purpose than to enhance productivity on the part of Education managers and for improved Education service delivery State-wide. Your support therefore is solicited to ensure successful completion of this instrument. We would appreciate your sincere responses.
    <br><br>
    <strong>Thank you.</strong>
    <br><br>
    <u>Instruction:</u> The instrument has Four Sections. Section A requires Bio Data; Section B requires School/Institution Data; Section C contains items on Education Managers’ Needs Assessment while Section D is on School Infrastructure. Kindly fill in the statements that are applicable to your school.
</div>
            
            <!-- TODO: Add SILNAT form here -->
<form id="silnatForm" class="audit-form" onsubmit="submitSilnat(event)">
            <div class="form-row full">
                <div class="form-group">
                    <label for="silnat_a_institution_type">Institution Type *</label>
                    <select id="silnat_a_institution_type" name="silnat_a_institution_type" class="form-control" required onchange="handleSilnatInstitutionTypeChange()">
                        <option value="">Select Institution Type</option>
                        <option value="regular_school">Regular School</option>
                        <option value="special_school">Special School</option>
                        <option value="home_economics_centre">Home Economics Centre</option>
                        <option value="mini_resource_centre">Mini Resource Centre</option>
                        <option value="lgea_secretariat">LGEA Secretariat</option>
                    </select>
                </div>
            </div>
            <!-- Section A: Bio Data - Conditional Wrappers -->
            <div id="silnat_a_ht_bio_data_wrapper" class="conditional-group for-regular_school for-special_school for-home_economics_centre for-mini_resource_centre" style="display:none;">
                <hr> <!-- Visual separator -->
                <h4>Head Teacher Bio Data</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="silnat_a_ht_name">Head Teacher/Manager Name *</label>
                        <input type="text" id="silnat_a_ht_name" name="silnat_a_ht_name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="silnat_a_ht_contact">Contact Number</label>
                        <input type="tel" id="silnat_a_ht_contact" name="silnat_a_ht_contact" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>Gender *</label>
                    <div>
                        <label class="radio-inline"><input type="radio" name="silnat_a_ht_gender" value="male" required> Male</label>
                        <label class="radio-inline"><input type="radio" name="silnat_a_ht_gender" value="female"> Female</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Marital Status *</label>
                    <div>
                        <label class="radio-inline"><input type="radio" name="silnat_a_ht_marital_status" value="single" required> Single</label>
                        <label class="radio-inline"><input type="radio" name="silnat_a_ht_marital_status" value="married"> Married</label>
                        <label class="radio-inline"><input type="radio" name="silnat_a_ht_marital_status" value="divorced"> Divorced</label>
                        <label class="radio-inline"><input type="radio" name="silnat_a_ht_marital_status" value="separated"> Separated</label>
                        <label class="radio-inline"><input type="radio" name="silnat_a_ht_marital_status" value="widow_widower"> Widow/Widower</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="silnat_a_ht_highest_qualification">Highest Qualification *</label>
                    <select id="silnat_a_ht_highest_qualification" name="silnat_a_ht_highest_qualification" class="form-control" required>
                        <option value="">Select Qualification</option>
                        <option value="grade_ii">Grade II</option> <option value="nce">NCE</option> <option value="b_ed">B.Ed</option> <option value="ba_ed">BA. Ed</option> <option value="bsc_ed">B.Sc.Ed</option> <option value="hnd">HND</option> <option value="m_ed">M.Ed</option> <option value="others">Others</option>
                    </select>
                </div>
                <div class="form-group conditional-sub-group for-silnat_a_ht_highest_qualification_others" style="display:none;">
                    <label for="silnat_a_ht_highest_qualification_other">Specify Other Qualification</label>
                    <input type="text" id="silnat_a_ht_highest_qualification_other" name="silnat_a_ht_highest_qualification_other" class="form-control">
                </div>
                <div class="form-group">
                    <label for="silnat_a_ht_years_experience">Years of Leadership Experience *</label>
                    <select id="silnat_a_ht_years_experience" name="silnat_a_ht_years_experience" class="form-control" required>
                        <option value="">Select Years</option>
                        <option value="5_below">5 & below</option> <option value="6_10">6-10</option> <option value="11_15">11-15</option> <option value="16_20">16-20</option> <option value="21_above">21 & above</option>
                    </select>
                </div>
            </div>

            <div id="silnat_a_es_bio_data_wrapper" class="conditional-group for-lgea_secretariat" style="display:none;">
                 <hr> <!-- Visual separator -->
                <h4>Education Secretary Bio Data</h4>
                <div class="form-row">
                     <div class="form-group">
                        <label for="silnat_a_es_name">Education Secretary Name *</label>
                        <input type="text" id="silnat_a_es_name" name="silnat_a_es_name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="silnat_a_es_contact">Contact Number</label>
                        <input type="tel" id="silnat_a_es_contact" name="silnat_a_es_contact" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>Gender *</label>
                    <div>
                        <label class="radio-inline"><input type="radio" name="silnat_a_es_gender" value="male" required> Male</label>
                        <label class="radio-inline"><input type="radio" name="silnat_a_es_gender" value="female"> Female</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Marital Status *</label>
                    <div>
                        <label class="radio-inline"><input type="radio" name="silnat_a_es_marital_status" value="single" required> Single</label>
                        <label class="radio-inline"><input type="radio" name="silnat_a_es_marital_status" value="married"> Married</label>
                        <label class="radio-inline"><input type="radio" name="silnat_a_es_marital_status" value="divorced"> Divorced</label>
                        <label class="radio-inline"><input type="radio" name="silnat_a_es_marital_status" value="separated"> Separated</label>
                        <label class="radio-inline"><input type="radio" name="silnat_a_es_marital_status" value="widow_widower"> Widow/Widower</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="silnat_a_es_highest_qualification">Highest Qualification *</label>
                    <select id="silnat_a_es_highest_qualification" name="silnat_a_es_highest_qualification" class="form-control" required>
                        <option value="">Select Qualification</option>
                        <option value="grade_ii">Grade II</option> <option value="nce">NCE</option> <option value="b_ed">B.Ed</option> <option value="ba_ed">BA. Ed</option> <option value="bsc_ed">B.Sc.Ed</option> <option value="hnd">HND</option> <option value="m_ed">M.Ed</option> <option value="others">Others</option>
                    </select>
                </div>
                <div class="form-group conditional-sub-group for-silnat_a_es_highest_qualification_others" style="display:none;">
                    <label for="silnat_a_es_highest_qualification_other">Specify Other Qualification</label>
                    <input type="text" id="silnat_a_es_highest_qualification_other" name="silnat_a_es_highest_qualification_other" class="form-control">
                </div>
                <div class="form-group">
                    <label for="silnat_a_es_years_experience">Years of Leadership Experience *</label>
                    <select id="silnat_a_es_years_experience" name="silnat_a_es_years_experience" class="form-control" required>
                        <option value="">Select Years</option>
                        <option value="5_below">5 & below</option> <option value="6_10">6-10</option> <option value="11_15">11-15</option> <option value="16_20">16-20</option> <option value="21_above">21 & above</option>
                    </select>
                </div>
            </div>
            <hr> <!-- Visual separator -->
            <!-- The original School Name and Local Gov fields will follow, to be refactored into Section B later -->
            <div class="form-row">
                <div class="form-group">
                    <label for="silnat_schoolName">Name of School/Institution *</label>
                    <input type="text" id="silnat_schoolName" name="silnat_b_institution_name_common" class="form-control" required>
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label for="silnat_b_institution_address">School/Institution Address *</label>
                    <textarea id="silnat_b_institution_address" name="silnat_b_institution_address" class="form-control" rows="3" required></textarea>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="silnat_localGov">Local Government *</label>
                    <input type="text" id="silnat_localGov" name="silnat_b_local_gov_common" class="form-control" required>
                </div>
            </div>
            <!-- The original Infrastructure Condition field will follow, to be refactored into Section D later -->
            <div class="form-row">
                <div class="form-group">
                    <label for="silnat_infrastructure">Infrastructure Condition *</label>
            <div class="form-row">
                <div class="form-group">
                    <label for="silnat_infrastructure">Infrastructure Condition *</label>
                    <select id="silnat_infrastructure" class="form-control" required>
                        <option value="">Select condition</option>
                        <option value="excellent">Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="silnat_leadership">Leadership Structure *</label>
                    <select id="silnat_leadership" class="form-control" required>
                        <option value="">Select</option>
                        <option value="well_structured">Well Structured</option>
                        <option value="average">Average</option>
                        <option value="needs_improvement">Needs Improvement</option>
                    </select>
                </div>
            </div>
            <div class="form-row full">
                <div class="form-group">
                    <label for="silnat_needs">Key Needs/Challenges *</label>
                    <textarea id="silnat_needs" class="form-control" rows="3" required></textarea>
                </div>
            </div>
            <div class="form-group">
                <label>Upload Photos (Max 5)</label>
                <input type="file" id="silnat_fileInput" multiple accept="image/*" class="form-control">
                <div id="silnat_uploadedFiles" class="uploaded-files"></div>
            </div>
            <button type="submit" class="btn">Submit SILNAT Survey</button>
            <div id="silnat_feedback" style="margin-top:15px;font-size:15px;"></div>
        </form>        </div>
        <div id="tcmatsSection" class="section hidden">
            <button class="btn btn-secondary" style="width:auto;margin-bottom:20px;" onclick="backToLanding()">← Back to Home</button>
            <div class="lagos-header" style="display:flex;align-items:center;gap:16px;justify-content:center;margin-bottom:24px;">
  <img src="subeb.jpg" alt="Lagos State Logo" style="height:48px;width:48px;border-radius:8px;border:3px solid var(--lagos-yellow);background:var(--lagos-white);box-shadow:0 2px 8px rgba(30,64,175,0.10);">
  <div style="font-size:1.6rem;font-weight:700;color:var(--lagos-blue);letter-spacing:1px;">Lagos State Universal Basic Education Board (LASUBEB)</div>
</div>
            <h2>Teachers Classroom Management and Teaching Survey (TCMATS)</h2>
            <!-- TODO: Add TCMATS form here -->
            <div style="color:#888;margin-top:40px;"><form id="tcmatsForm" class="audit-form" onsubmit="submitTcmats(event)">
    <div class="form-row">
        <div class="form-group">
            <label for="tcmats_teacherName">Teacher Name *</label>
            <input type="text" id="tcmats_teacherName" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="tcmats_school">School *</label>
            <input type="text" id="tcmats_school" class="form-control" required>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label for="tcmats_subject">Subject *</label>
            <input type="text" id="tcmats_subject" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="tcmats_class">Class *</label>
            <input type="text" id="tcmats_class" class="form-control" required>
        </div>
    </div>
    <div class="form-row full">
        <div class="form-group">
            <label for="tcmats_observation">Observation *</label>
            <textarea id="tcmats_observation" class="form-control" rows="4" required></textarea>
        </div>
    </div>
    <div class="form-group">
        <label>Upload Evidence (Max 3)</label>
        <input type="file" id="tcmats_fileInput" multiple accept="image/*" class="form-control">
        <div id="tcmats_uploadedFiles" class="uploaded-files"></div>
    </div>
    <button type="submit" class="btn">Submit TCMATS Survey</button>
    <div id="tcmats_feedback" style="margin-top:15px;font-size:15px;"></div>
</form></div>
        </div>
        <div id="loriSection" class="section hidden">
            <button class="btn btn-secondary" style="width:auto;margin-bottom:20px;" onclick="backToLanding()">← Back to Home</button>
            <div class="lagos-header" style="display:flex;align-items:center;gap:16px;justify-content:center;margin-bottom:24px;">
  <img src="subeb.jpg" alt="Lagos State Logo" style="height:48px;width:48px;border-radius:8px;border:3px solid var(--lagos-yellow);background:var(--lagos-white);box-shadow:0 2px 8px rgba(30,64,175,0.10);">
  <div style="font-size:1.6rem;font-weight:700;color:var(--lagos-blue);letter-spacing:1px;">Lagos State Universal Basic Education Board (LASUBEB)</div>
</div>
            <h2>Lesson Observation Rating Instrument (LORI)</h2>
            <!-- TODO: Add LORI form here -->
            <div style="color:#888;margin-top:40px;"><form id="loriForm" class="audit-form" onsubmit="submitLori(event)">
    <div class="form-row">
        <div class="form-group">
            <label for="lori_assessorName">Assessor Name *</label>
            <input type="text" id="lori_assessorName" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="lori_teacherName">Teacher Name *</label>
            <input type="text" id="lori_teacherName" class="form-control" required>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label for="lori_school">School *</label>
            <input type="text" id="lori_school" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="lori_class">Class *</label>
            <input type="text" id="lori_class" class="form-control" required>
        </div>
    </div>
    <div class="form-row full">
        <div class="form-group">
            <label for="lori_rating">Lesson Rating (1-5) *</label>
            <select id="lori_rating" class="form-control" required>
                <option value="">Select rating</option>
                <option value="1">1 - Poor</option>
                <option value="2">2 - Fair</option>
                <option value="3">3 - Good</option>
                <option value="4">4 - Very Good</option>
                <option value="5">5 - Excellent</option>
            </select>
        </div>
    </div>
    <div class="form-row full">
        <div class="form-group">
            <label for="lori_comments">Comments</label>
            <textarea id="lori_comments" class="form-control" rows="3"></textarea>
        </div>
    </div>
    <div class="form-group">
        <label>Upload Evidence (Max 3)</label>
        <input type="file" id="lori_fileInput" multiple accept="image/*" class="form-control">
        <div id="lori_uploadedFiles" class="uploaded-files"></div>
    </div>
    <button type="submit" class="btn">Submit LORI Survey</button>
    <div id="lori_feedback" style="margin-top:15px;font-size:15px;"></div>
</form></div>
        </div>
        <div id="voicesSection" class="section hidden">
            <button class="btn btn-secondary" style="width:auto;margin-bottom:20px;" onclick="backToLanding()">← Back to Home</button>
            <div class="lagos-header" style="display:flex;align-items:center;gap:16px;justify-content:center;margin-bottom:24px;">
  <img src="subeb.jpg" alt="Lagos State Logo" style="height:48px;width:48px;border-radius:8px;border:3px solid var(--lagos-yellow);background:var(--lagos-white);box-shadow:0 2px 8px rgba(30,64,175,0.10);">
  <div style="font-size:1.6rem;font-weight:700;color:var(--lagos-blue);letter-spacing:1px;">Lagos State Universal Basic Education Board (LASUBEB)</div>
</div>
            <h2>Learner Voices/Opinions (VOICES)</h2>
            <!-- TODO: Add VOICES form here -->
            <div style="color:#888;margin-top:40px;">
<form id="voicesForm" class="audit-form" onsubmit="submitVoices(event)">
    <div class="form-row">
        <div class="form-group">
            <label for="voices_learnerName">Learner Name *</label>
            <input type="text" id="voices_learnerName" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="voices_age">Age *</label>
            <input type="number" id="voices_age" class="form-control" min="5" max="20" required>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label for="voices_school">School *</label>
            <input type="text" id="voices_school" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="voices_class">Class *</label>
            <input type="text" id="voices_class" class="form-control" required>
        </div>
    </div>
    <div class="form-row full">
        <div class="form-group">
            <label for="voices_opinion">Learner's Opinion *</label>
            <textarea id="voices_opinion" class="form-control" rows="4" required></textarea>
        </div>
    </div>
    <div class="form-group">
        <label>Upload Evidence (Max 2)</label>
        <input type="file" id="voices_fileInput" multiple accept="image/*" class="form-control">
        <div id="voices_uploadedFiles" class="uploaded-files"></div>
    </div>
    <button type="submit" class="btn">Submit VOICES Survey</button>
    <div id="voices_feedback" style="margin-top:15px;font-size:15px;"></div>
</form></div>
        </div>
        <!-- Main Application (hidden until needed) -->
        <div id="mainApp" class="hidden">
            <div class="header">
                <div class="logo">
                    <img src="subeb.jpg" alt="Lagos State Logo">
                    Personnel & Facility Audit
                </div>
                <button class="hamburger" onclick="toggleMobileSidebar()" aria-label="Open navigation">
                    <span></span><span></span><span></span>
                </button>
                <div class="status">
                    <div id="connectionStatus" class="status-dot"></div>
                    <span id="connectionText">Online</span>
                    <button class="btn btn-secondary" style="width:auto;padding:8px 16px;margin-left:20px;" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="main-content">
                <div class="sidebar">
                    <div class="nav-item active" onclick="showSection('dashboard')">📊 Dashboard</div>
                    <div class="nav-item" onclick="showSection('audit')">📝 New Audit</div>
                    <div class="nav-item" onclick="showSection('records')">📋 Records</div>
                    <div class="nav-item" onclick="showSection('sync')">🔄 Sync Data</div>
                </div>

                <div class="content-area">
                    <!-- Dashboard Section -->
                    <div id="dashboardSection" class="section">
                        <h2>Dashboard</h2>
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="totalAudits">0</div>
                                <div class="stat-label">Total Audits</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="pendingSync">0</div>
                                <div class="stat-label">Pending Sync</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="completedToday">0</div>
                                <div class="stat-label">Completed Today</div>
                            </div>
                        </div>

                        <h3>Recent Audits</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>School Name</th>
                                    <th>Local Government</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentAuditsTable">
                                <tr>
                                    <td colspan="4" style="text-align:center;padding:40px;color:#6b7280;">No audits completed yet</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Bulk Upload CSV -->
<div style="margin-bottom:20px;">
    <label for="csvUpload" style="font-weight:600;color:var(--lagos-navy);margin-right:10px;">Bulk Upload Audits (CSV):</label>
    <input type="file" id="csvUpload" accept=".csv" style="display:inline-block;width:auto;" onchange="handleCSVUpload(event)">
    <button class="btn btn-secondary" style="width:auto;padding:8px 16px;margin-left:10px;" onclick="triggerCSVInput()">Upload CSV</button>
    <span id="csvUploadMsg" style="margin-left:15px;font-size:14px;color:var(--lagos-red);"></span>
</div>

                    </div>

                    <!-- Audit Form Section -->
                    <div id="auditSection" class="section hidden">
                        <h2>New Personnel & Facility Audit</h2>
                        <form id="auditForm" class="audit-form" onsubmit="saveAudit(event)">
                            <div class="form-row"> <div class="form-group"> <label for="localGov">Local Government *</label> <select id="localGov" class="form-control" required onchange="loadSchools()"> <option value="">Select Local Government</option> </select> </div> <div class="form-group"> <label for="schoolName">Primary School *</label> <select id="schoolName" class="form-control" required disabled> <option value="">Select LGA first</option> </select> </div> </div>

                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="schoolAddress">School Address *</label>
                                    <textarea id="schoolAddress" class="form-control" rows="3" required></textarea>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="latitude">Latitude</label>
                                    <input type="number" id="latitude" class="form-control" step="any" readonly>
                                    <button type="button" class="location-btn" onclick="getLocation()">📍 Get Current Location</button>
                                </div>
                                <div class="form-group">
                                    <label for="longitude">Longitude</label>
                                    <input type="number" id="longitude" class="form-control" step="any" readonly>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="principalName">Principal Name</label>
                                    <input type="text" id="principalName" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="totalTeachers">Total Teachers</label>
                                    <input type="number" id="totalTeachers" class="form-control" min="0">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="totalStudents">Total Students</label>
                                    <input type="number" id="totalStudents" class="form-control" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="facilityCondition">Facility Condition</label>
                                    <select id="facilityCondition" class="form-control">
                                        <option value="">Select condition</option>
                                        <option value="excellent">Excellent</option>
                                        <option value="good">Good</option>
                                        <option value="fair">Fair</option>
                                        <option value="poor">Poor</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="additionalNotes">Additional Notes/Observations</label>
                                    <textarea id="additionalNotes" class="form-control" rows="4"></textarea>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Upload Photos (Max 5)</label>
                                <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                                    <div>📸 Click to upload up to 5 photos or drag & drop</div>
                                    <div style="font-size:14px;color:#6b7280;margin-top:10px;">JPG, PNG files only</div>
                                </div>
                                <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" onchange="handleFiles(this.files)">
                                <div class="uploaded-files" id="uploadedFiles"></div>
                                <div id="photoLimitMsg" style="color:var(--lagos-red);font-size:13px;margin-top:8px;display:none;">You can only upload up to 5 photos.</div>
                            </div>

                            <button type="submit" class="btn">💾 Save Audit</button>
                        </form>
                    </div>

                    <!-- Records Section -->
                    <div id="recordsSection" class="section hidden">
                        <h2>Audit Records</h2>
                        <button class="btn" style="width:auto;margin-bottom:20px;" onclick="exportToCSV()">⬇️ Export to CSV</button>
                        <div style="margin-bottom:10px;">
                            <button class="btn btn-secondary" style="width:auto;padding:8px 16px;" onclick="bulkEditRecords()">🛠️ Bulk Edit</button>
                            <button class="btn btn-secondary" style="width:auto;padding:8px 16px;margin-left:10px;" onclick="bulkDeleteRecords()">🗑️ Bulk Delete</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllCheckbox"></th>
                                    <th>School Name</th>
                                    <th>Local Government</th>
                                    <th>Date</th>
                                    <th>Principal</th>
                                    <th>Teachers</th>
                                    <th>Students</th>
                                    <th>Sync Status</th>
                                    <th>Photos</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTable">
                                <tr>
                                    <td colspan="10" style="text-align:center;padding:40px;color:#6b7280;">No records found</td>
                                </tr>
                            </tbody>
                        </table>
                        <div id="paginationControls" style="margin-top:10px;text-align:center;"></div>
                    </div>

                    <!-- Sync Section -->
                    <div id="syncSection" class="section hidden">
                        <h2>Data Synchronization</h2>
                        <div style="background:#f0f9ff;padding:20px;border-radius:10px;margin-bottom:20px;">
                            <h3>Sync Status</h3>
                            <p>Pending sync: <span id="pendingSyncCount">0</span> records</p>
                            <button class="btn" style="width:auto;padding:12px 24px;margin-top:10px;" onclick="syncData()">🔄 Sync Now</button>
                        </div>
                        <div id="syncLog" style="background:#f9fafb;padding:20px;border-radius:10px;max-height:300px;overflow-y:auto;">
                            <p style="color:#6b7280;">Sync log will appear here...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add this mobile sidebar -->
            <div class="mobile-sidebar hidden" id="mobileSidebar">
                <div class="nav-item" onclick="showSection('dashboard');toggleMobileSidebar();">📊 Dashboard</div>
                <div class="nav-item" onclick="showSection('audit');toggleMobileSidebar();">📝 New Audit</div>
                <div class="nav-item" onclick="showSection('records');toggleMobileSidebar();">📋 Records</div>
                <div class="nav-item" onclick="showSection('sync');toggleMobileSidebar();">🔄 Sync Data</div>
                <button class="btn btn-secondary" style="margin-top:20px;" onclick="logout();toggleMobileSidebar();">Logout</button>
            </div>
        </div>
    </div>
    <style>
        .survey-card {
            background: var(--lagos-white);
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(30,64,175,0.08);
            border: 3px solid var(--lagos-blue);
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: box-shadow 0.2s, border-color 0.2s, transform 0.2s;
            min-height: 180px;
        }
        .survey-card:hover {
            border-color: var(--lagos-green);
            box-shadow: 0 8px 32px rgba(30,64,175,0.18);
            transform: translateY(-4px) scale(1.03);
        }
        .survey-card h2 {
            font-size: 1.2rem;
            color: var(--lagos-blue);
            margin-bottom: 10px;
        }
        .survey-card p {
            color: var(--lagos-dark-gray);
            font-size: 1rem;
        }

/* Lagos State form field branding and white text */
.section {
  background: var(--lagos-blue);
  color: var(--lagos-white);
}
.form-group label {
  color: var(--lagos-yellow) !important;
  font-weight: 600;
}
.form-control,
.form-control:focus,
select.form-control,
textarea.form-control {
  background: rgba(30,64,175,0.85) !important; /* Lagos blue, slightly transparent */
  color: var(--lagos-white) !important;
  border: 2px solid var(--lagos-yellow) !important;
  border-radius: 10px;
  font-size: 16px;
  transition: all 0.3s;
}
.form-control:focus {
  border-color: var(--lagos-green) !important;
  box-shadow: 0 0 0 3px rgba(250,204,21,0.15);
}
input::placeholder, textarea::placeholder {
  color: #e5e5e5 !important;
  opacity: 1;
}
select.form-control option {
  color: var(--lagos-navy);
  background: var(--lagos-yellow);
}
.audit-form {
  color: var(--lagos-white);
}

    </style>
    <script>
    // Navigation logic for landing/surveys
    function showSurvey(survey) {
        document.getElementById('landingPage').classList.add('hidden');
        ['silnat','tcmats','lori','voices'].forEach(s => {
            document.getElementById(s+'Section').classList.add('hidden');
        });
        document.getElementById(survey+'Section').classList.remove('hidden');
        // Hide main app unless you want to show it for a survey
        document.getElementById('mainApp').classList.add('hidden');
    }
    function backToLanding() {
        document.getElementById('landingPage').classList.remove('hidden');
        ['silnat','tcmats','lori','voices'].forEach(s => {
            document.getElementById(s+'Section').classList.add('hidden');
        });
        document.getElementById('mainApp').classList.add('hidden');
    }
    // On load, show landing page only
    window.onload = function() {
        document.getElementById('landingPage').classList.remove('hidden');
        ['silnat','tcmats','lori','voices'].forEach(s => {
            document.getElementById(s+'Section').classList.add('hidden');
        });
        document.getElementById('mainApp').classList.add('hidden');
    };
    </script>
    <script>

// Lagos State Local Government Areas and Primary Schools Data 
let lagosStateData = { "Agege": [ "Agege Primary School I", "Agege Primary School II", "Oko-Oba Primary School", "Mulero Primary School", "Pen Cinema Primary School", "Dopemu Primary School" ], "Ajeromi-Ifelodun": [ "Ajeromi Primary School", "Ifelodun Primary School I", "Ifelodun Primary School II", "Boundary Primary School", "Alakija Primary School", "Olodi Primary School" ], "Alimosho": [ "Alimosho Primary School I", "Alimosho Primary School II", "Idimu Primary School", "Ikotun Primary School", "Egbe Primary School", "Iyana Ipaja Primary School" ], "Amuwo-Odofin": [ "Amuwo-Odofin Primary School", "Festac Primary School I", "Festac Primary School II", "Trade Fair Primary School", "Mile 2 Primary School", "Kirikiri Primary School" ], "Apapa": [ "Apapa Primary School I", "Apapa Primary School II", "Liverpool Primary School", "Creek Road Primary School", "Point Road Primary School", "Warehouse Primary School" ], "Badagry": [ "Badagry Primary School I", "Badagry Primary School II", "Ajara Primary School", "Iworo Primary School", "Koga Primary School", "Topo Primary School" ], "Epe": [ "Epe Primary School I", "Epe Primary School II", "Ejinrin Primary School", "Noforija Primary School", "Lekki Primary School", "Orimedu Primary School" ], "Eti-Osa": [ "Victoria Island Primary School", "Ikoyi Primary School", "Lekki Phase I Primary School", "Ajah Primary School", "Eti-Osa Primary School", "Ilasan Primary School" ], "Ibeju-Lekki": [ "Ibeju Primary School", "Lekki Primary School", "Akodo Primary School", "Elemoro Primary School", "Bogije Primary School", "Eleko Primary School" ], "Ifako-Ijaiye": [ "Ifako Primary School", "Ijaiye Primary School I", "Ijaiye Primary School II", "Alakuko Primary School", "Ojokoro Primary School", "Agbado Primary School" ], "Ikeja": [ "Ikeja Primary School I", "Ikeja Primary School II", "GRA Primary School", "Maryland Primary School", "Alausa Primary School", "Computer Village Primary School" ], "Ikorodu": [ "Ikorodu Primary School I", "Ikorodu Primary School II", "Igbogbo Primary School", "Bayeku Primary School", "Ijede Primary School", "Imota Primary School" ], "Kosofe": [ "Kosofe Primary School", "Ketu Primary School I", "Ketu Primary School II", "Mile 12 Primary School", "Owode Primary School", "Agboyi Primary School" ], "Lagos Island": [ "Lagos Island Primary School I", "Lagos Island Primary School II", "Tafawa Balewa Primary School", "Campos Primary School", "Oke-Arin Primary School", "Marina Primary School" ], "Lagos Mainland": [ "Lagos Mainland Primary School", "Yaba Primary School I", "Yaba Primary School II", "Ebute-Metta Primary School", "Oyingbo Primary School", "Sabo Primary School" ], "Mushin": [ "Mushin Primary School I", "Mushin Primary School II", "Papa Ajao Primary School", "Isolo Primary School", "Idi-Oro Primary School", "Oke-Afa Primary School" ], "Ojo": [ "Ojo Primary School I", "Ojo Primary School II", "Alaba Primary School", "Okokomaiko Primary School", "Shibiri Primary School", "Igando Primary School" ], "Oshodi-Isolo": [ "Oshodi Primary School I", "Oshodi Primary School II", "Isolo Primary School I", "Isolo Primary School II", "Mafoluku Primary School", "Bolade Primary School" ], "Shomolu": [ "Shomolu Primary School I", "Shomolu Primary School II", "Bariga Primary School", "Pedro Primary School", "Akoka Primary School", "Gbagada Primary School" ], "Surulere": [ "Surulere Primary School I", "Surulere Primary School II", "Itire Primary School", "Lawanson Primary School", "Aguda Primary School", "Adelabu Primary School" ] };

// Load lagosStateData from localStorage if present
(function loadLagosStateData() {
    try {
        const savedLagosData = localStorage.getItem('lagosStateData');
        if (savedLagosData) {
            lagosStateData = JSON.parse(savedLagosData);
        }
    } catch (e) {
        console.error('Error loading lagosStateData from localStorage:', e);
    }
})();

// --- Load lagosStateData from backend if available ---
(async function fetchLagosStateDataFromBackend() {
    try {
        const response = await fetch('/api/lgas');
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.lagosStateData && Object.keys(result.lagosStateData).length > 0) {
                lagosStateData = result.lagosStateData;
                localStorage.setItem('lagosStateData', JSON.stringify(lagosStateData));
                loadLocalGovernments && loadLocalGovernments();
                console.log('Loaded lagosStateData from backend.');
            }
        }
    } catch (e) {
        console.warn('Could not fetch lagosStateData from backend:', e);
    }
})();

// Global variables
        let currentUser = null;
        let auditData = [];
        let uploadedFiles = [];
        let isOnline = navigator.onLine;
        
        // Replace the existing window.onload function
window.onload = function() {
    console.log('App initialized');
    loadSession();
    if (currentUser) {
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        loadData();
        loadLocalGovernments();
        updateDashboard();
        loadRecords();
        updateConnectionStatus();
        loadFromServer(); // Only load from server if logged in
    } else {
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }
};


// Add this new function to load saved session
function loadSession() {
    try {
        const savedUser = localStorage.getItem('auditAppCurrentUser');
        if (savedUser) {
            currentUser = savedUser;
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            console.log('Session restored for user:', currentUser);
        }
    } catch (e) {
        console.error('Error loading session:', e);
    }
}


       // --- PATCH: Fix frontend login bug (robust trim, lowercase, and error display) ---
function login() {
    const username = document.getElementById('username').value.trim().toLowerCase();
    const password = document.getElementById('password').value.trim();
    console.log('Login attempt:', username, password);
    // Accept only exact credentials (case-insensitive username)
    if ((username === 'admin' && password === 'password123') || 
        (username === 'auditor' && password === 'audit2024')) {
        currentUser = username;
        // Save session to localStorage
        localStorage.setItem('auditAppCurrentUser', username);
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        console.log('Login successful');
        loadData();
        loadLocalGovernments();
        updateDashboard();
        loadRecords();
    } else {
        // Show error message in UI
        let msg = document.getElementById('loginErrorMsg');
        if (!msg) {
            msg = document.createElement('div');
            msg.id = 'loginErrorMsg';
            msg.style.color = 'var(--lagos-red)';
            msg.style.marginTop = '10px';
            msg.style.textAlign = 'center';
            document.getElementById('authScreen').appendChild(msg);
        }
        msg.textContent = 'Invalid credentials!\n\nValid login credentials:\n• admin / password123\n• auditor / audit2024';
        setTimeout(()=>{msg.textContent='';}, 5000);
        console.log('Login failed');
    }
}
        
// Modify the existing logout function (replace the existing one)
function logout() {
    currentUser = null;
    // Remove session from localStorage
    localStorage.removeItem('auditAppCurrentUser');
    
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';

}

        // Navigation
        function showSection(sectionName, navElem) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Update navigation
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            if (navElem) {
                navElem.classList.add('active');
            }
            if (sectionName === 'dashboard') updateDashboard();
    if (sectionName === 'records') loadRecords(); // Use loadRecords instead of loadFromServer
    if (sectionName === 'sync') updateSyncSection && updateSyncSection();
        }

        // Get current location
        function getLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    document.getElementById('latitude').value = position.coords.latitude;
                    document.getElementById('longitude').value = position.coords.longitude;
                    alert('Location captured successfully!');
                },
                function(error) {
                    alert('Error getting location: ' + error.message);
                }
            );
        }


// Resize image to max width/height before saving as base64
function resizeImage(file, maxSize = 400, quality = 0.4) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                let width = img.width;
                let height = img.height;
                if (width > height) {
                    if (width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                // Use JPEG for better compression, fallback to PNG
                let mimeType = file.type === "image/png" ? "image/png" : "image/jpeg";
                resolve(canvas.toDataURL(mimeType, quality));
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

        // Handle file uploads
     // Handle file uploads
function handleFiles(files) {
    const maxPhotos = 5;
    let filesToAdd = Array.from(files);
    if (uploadedFiles.length + filesToAdd.length > maxPhotos) {
        filesToAdd = filesToAdd.slice(0, maxPhotos - uploadedFiles.length);
        document.getElementById('photoLimitMsg').style.display = 'block';
    } else {
        document.getElementById('photoLimitMsg').style.display = 'none';
    }
    let resizePromises = [];
    for (let i = 0; i < filesToAdd.length; i++) {
        const file = filesToAdd[i];
        if (file.type.startsWith('image/')) {
            // Resize before saving
            const p = resizeImage(file).then(resizedDataUrl => {
                uploadedFiles.push({
                    name: file.name,
                    data: resizedDataUrl,
           
                    type: file.type
                });
                displayFile(file.name, resizedDataUrl);
            });
            resizePromises.push(p);
        }
    }
    Promise.all(resizePromises).then(updateFileDisplay);
}

        // Add this anywhere in your <script> tag
function toggleMobileSidebar() {
    const sidebar = document.getElementById('mobileSidebar');
    if (sidebar) {
        sidebar.classList.toggle('hidden');
    }
}
        function displayFile(name, dataUrl) {
            const container = document.getElementById('uploadedFiles');
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-preview';
            // Add a download button for the image
            fileDiv.innerHTML = `
                <img src="${dataUrl}" alt="${name}">
                <button class="file-remove" onclick="removeFile('${name}')">×</button>
                <a href="${dataUrl}" download="${name}" class="file-download" title="Download"><span style="font-size:18px;position:absolute;bottom:5px;right:5px;background:rgba(30,64,175,0.8);color:#fff;padding:2px 8px;border-radius:6px;">⬇️</span></a>
            `;
            container.appendChild(fileDiv);
        }
        function removeFile(name) {
            uploadedFiles = uploadedFiles.filter(file => file.name !== name);
            updateFileDisplay();
            if (uploadedFiles.length < 5) {
                document.getElementById('photoLimitMsg').style.display = 'none';
            }
        }
        function updateFileDisplay() {
            const container = document.getElementById('uploadedFiles');
            container.innerHTML = '';
            uploadedFiles.forEach(file => {
                displayFile(file.name, file.data);
            });
            if (uploadedFiles.length >= 5) {
                document.getElementById('fileInput').disabled = true;
            } else {
                document.getElementById('fileInput').disabled = false;
            }
        }

 // Load Local Government Areas into dropdown 
 function loadLocalGovernments() {
    const localGovDropdown = document.getElementById('localGov');
    const lgas = Object.keys(lagosStateData).sort();
    localGovDropdown.innerHTML = '<option value="">Select Local Government</option>';
    lgas.forEach(lga => {
        const option = document.createElement('option');
        option.value = lga;
        option.textContent = lga;
        localGovDropdown.appendChild(option);
    });
    // Reset school dropdown
    const schoolDropdown = document.getElementById('schoolName');
    schoolDropdown.innerHTML = '<option value="">Select LGA first</option>';
    schoolDropdown.disabled = true;
}

function loadSchools() {
    const localGov = document.getElementById('localGov').value;
    const schoolDropdown = document.getElementById('schoolName');
    schoolDropdown.innerHTML = '<option value="">Select Primary School</option>';
    if (!localGov) {
        schoolDropdown.disabled = true;
        schoolDropdown.innerHTML = '<option value="">Select LGA first</option>';
        return;
    }
    schoolDropdown.disabled = false;
    const schools = lagosStateData[localGov] || [];
    schools.forEach(school => {
        const option = document.createElement('option');
        option.value = school;
        option.textContent = school;
        schoolDropdown.appendChild(option);
    });
}


// --- CSV IMPORT: Replace LGAs and Schools in Form Dropdowns and Import Records ---
function handleCSVUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!file.name.endsWith('.csv')) {
        document.getElementById('csvUploadMsg').textContent = 'Please select a valid CSV file.';
        return;
    }
    const reader = new FileReader();
    reader.onload = async function(e) {
        const text = e.target.result;
        const result = parseCSV(text);
        if (result.error) {
            document.getElementById('csvUploadMsg').textContent = result.error;
            return;
        }
        // Build new LGA->Schools mapping from CSV (only use School Name and Local Government fields)
        const csvLgaSchools = {};
        result.data.forEach((row) => {
            const getAny = (...keys) => {
                for (const k of keys) {
                    for (const header of Object.keys(row)) {
                        if (header.replace(/\s|_/g, '').toLowerCase() === k.replace(/\s|_/g, '').toLowerCase()) {
                            return (row[header] !== undefined && row[header] !== null) ? String(row[header]).trim() : '';
                        }
                    }
                }
                return '';
            };
            const lga = getAny('Local Government', 'LGA');
            const school = getAny('School Name', 'School');
            if (!lga || !school) return;
            if (!csvLgaSchools[lga]) csvLgaSchools[lga] = new Set();
            csvLgaSchools[lga].add(school);
        });
        // Convert sets to sorted arrays
        const newLgaSchools = {};
        Object.keys(csvLgaSchools).forEach(lga => {
            newLgaSchools[lga] = Array.from(csvLgaSchools[lga]).sort();
        });
        // Overwrite global lagosStateData with only imported data (remove all previous keys)
        Object.keys(lagosStateData).forEach(key => { delete lagosStateData[key]; });
        Object.assign(lagosStateData, newLgaSchools);
        // Persist lagosStateData to localStorage
        try {
            localStorage.setItem('lagosStateData', JSON.stringify(lagosStateData));
        } catch (e) {
            console.error('Error saving lagosStateData to localStorage:', e);
        }
        // --- PATCH: POST lagosStateData as { lagosStateData } to backend for MongoDB persistence ---
        try {
            await fetch('/api/lgas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lagosStateData })
            });
            console.log('LGA/school mapping saved to backend.');
        } catch (err) {
            console.error('Failed to save LGA/school mapping to backend:', err);
        }
        // Update dropdowns to only show imported LGAs and schools
        loadLocalGovernments();
        document.getElementById('schoolName').innerHTML = '<option value="">Select LGA first</option>';
        document.getElementById('schoolName').disabled = true;
        // Do NOT import records or update dashboard/records table
        document.getElementById('csvUploadMsg').style.color = 'var(--lagos-green)';
        document.getElementById('csvUploadMsg').textContent = `Imported ${Object.keys(newLgaSchools).length} LGAs from CSV. Use the form to add new audits.`;
        setTimeout(()=>{document.getElementById('csvUploadMsg').textContent='';}, 4000);
    };
    reader.readAsText(file);
}

// Update loadLocalGovernments to only use lagosStateData (no old LGAs)
function loadLocalGovernments() {
    const localGovDropdown = document.getElementById('localGov');
    const lgas = Object.keys(lagosStateData).sort();
    localGovDropdown.innerHTML = '<option value="">Select Local Government</option>';
    lgas.forEach(lga => {
        const option = document.createElement('option');
        option.value = lga;
        option.textContent = lga;
        localGovDropdown.appendChild(option);
    });
}

// CSV parsing function
function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
    if (lines.length < 2) return { error: 'CSV must have a header and at least one data row.' };
    // Parse header
    const headerLine = lines[0];
    const headers = [];
    let col = '', inQuotes = false;
    for (let i = 0; i < headerLine.length; i++) {
        const char = headerLine[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { headers.push(col.trim()); col = ''; }
        else col += char;
    }
    headers.push(col.trim());
    // Parse rows
    const data = [];
    for (let l = 1; l < lines.length; l++) {
        const row = {};
        let val = '', inQuotes = false, colIdx = 0;
        const line = lines[l];
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') inQuotes = !inQuotes;
            else if (char === ',' && !inQuotes) { row[headers[colIdx++]] = val.replace(/^"|"$/g, '').trim(); val = ''; }
            else val += char;
        }
        row[headers[colIdx]] = val.replace(/^"|"$/g, '').trim();
        // Only add row if at least one field is non-empty
        if (Object.values(row).some(v => v && v.length > 0)) data.push(row);
    }
    return { data };
}

// --- PATCH: Persist auditData to localStorage and load on app start ---
function saveData() {
    try {
        localStorage.setItem('auditData', JSON.stringify(auditData));
    } catch (e) {
        console.error('Error saving auditData to localStorage:', e);
    }
}

function loadData() {
    try {
        const saved = localStorage.getItem('auditData');
        if (saved) {
            auditData = JSON.parse(saved);
        } else {
            auditData = [];
        }
    } catch (e) {
        auditData = [];
        console.error('Error loading auditData from localStorage:', e);
    }
}

// --- PATCH: Render auditData into records table with pagination and actions ---
function loadRecords(page = 1, pageSize = 10) {
    // Ensure auditData is loaded
    if (!Array.isArray(auditData)) auditData = [];
    const table = document.getElementById('recordsTable');
    if (!table) return;
    // Pagination
    const total = auditData.length;
    const totalPages = Math.ceil(total / pageSize) || 1;
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;
    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    const pageData = auditData.slice(start, end);
    // Render rows
    if (pageData.length === 0) {
        table.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:40px;color:#6b7280;">No records found</td></tr>';
    } else {
        table.innerHTML = pageData.map(audit => `
            <tr>
                <td><input type="checkbox" data-id="${audit.id}"></td>
                <td>${audit.schoolName || ''}</td>
                <td>${audit.localGov || ''}</td>
                <td>${audit.timestamp ? new Date(audit.timestamp).toLocaleString() : ''}</td>
                <td>${audit.principalName || ''}</td>
                <td>${audit.totalTeachers || 0}</td>
                <td>${audit.totalStudents || 0}</td>
                <td><span class="sync-status ${audit.synced ? 'synced' : 'pending'}">${audit.synced ? 'Synced' : 'Pending'}</span></td>
                <td>
                    ${(audit.photos && audit.photos.length) ? audit.photos.map(filename =>
                        `<a href="${getImageUrl(filename)}" target="_blank" style="margin-right:4px;display:inline-block;vertical-align:middle;">
                            <img src="${getImageUrl(filename)}" alt="Photo" style="width:40px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #e5e7eb;" onerror="this.style.display='none'">
                        </a>`
                    ).join('') : '<span style="color:#aaa;font-size:13px;">No photo</span>'}
                </td>
                <td>
                    <button class="btn btn-secondary" style="width:auto;padding:4px 10px;font-size:13px;" onclick="editRecord(${audit.id})">Edit</button>
                    <button class="btn btn-secondary" style="width:auto;padding:4px 10px;font-size:13px;margin-left:4px;background:var(--lagos-red);border-color:var(--lagos-yellow);" onclick="deleteRecord(${audit.id})">Delete</button>
                </td>
            </tr>
        `).join('');
    }
    // Pagination controls
    const controls = document.getElementById('paginationControls');
    if (controls) {
        let html = '';
        if (totalPages > 1) {
            html += `<button onclick="loadRecords(${page - 1}, ${pageSize})" ${page === 1 ? 'disabled' : ''}>Prev</button> `;
            html += `Page ${page} of ${totalPages} `;
            html += `<button onclick="loadRecords(${page + 1}, ${pageSize})" ${page === totalPages ? 'disabled' : ''}>Next</button>`;
        }
        controls.innerHTML = html;
    }
    // Select all checkbox logic
    const selectAll = document.getElementById('selectAllCheckbox');
    if (selectAll) {
        selectAll.checked = false;
        selectAll.onclick = function() {
            const checkboxes = table.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        };
    }
}

// --- PATCH: Backend persistence for audits ---
// On app load, fetch audits from backend and update auditData/localStorage
async function fetchAuditsFromBackend() {
    try {
        const response = await fetch('/api/audits');
        if (response.ok) {
            const audits = await response.json();
            if (Array.isArray(audits)) {
                auditData = audits;
                saveData();
                loadRecords();
                updateDashboard && updateDashboard();
            }
        }
    } catch (e) {
        console.warn('Could not fetch audits from backend:', e);
    }
}

// On app load, fetch audits from backend after login/session restore
(function patchAuditBackendLoad() {
    const origLoadData = window.loadData;
    window.loadData = function() {
        origLoadData && origLoadData();
        fetchAuditsFromBackend();
    };
})();

// Save audit to backend on add/edit
async function saveAudit(event) {
    event.preventDefault();
    if (uploadedFiles.length > 5) {
        alert('You can only upload up to 5 photos.');
        return;
    }
    if (!confirm('Are you sure you want to save this audit?')) {
        return;
    }
    const form = document.getElementById('auditForm');
    const editId = form.getAttribute('data-edit-id');
    let audit;
    // Upload images to backend first
    const photoNames = [];
    for (const file of uploadedFiles) {
        if (file.data && file.name) {
            let base64Data = file.data;
            if (base64Data.startsWith('data:')) {
                base64Data = base64Data.split(',')[1];
            }
            await fetch('/api/photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name, data: base64Data, type: file.type || 'image/jpeg' })
            });
            photoNames.push(file.name);
        }
    }
    if (editId) {
        // Edit mode: update existing audit
        const idx = auditData.findIndex(a => a.id == editId);
        if (idx === -1) return alert('Audit not found.');
        audit = auditData[idx];
        audit.schoolName = document.getElementById('schoolName').value;
        audit.localGov = document.getElementById('localGov').value;
        audit.schoolAddress = document.getElementById('schoolAddress').value;
        audit.latitude = parseFloat(document.getElementById('latitude').value) || null;
        audit.longitude = parseFloat(document.getElementById('longitude').value) || null;
        audit.principalName = document.getElementById('principalName').value;
        audit.totalTeachers = parseInt(document.getElementById('totalTeachers').value) || 0;
        audit.totalStudents = parseInt(document.getElementById('totalStudents').value) || 0;
        audit.facilityCondition = document.getElementById('facilityCondition').value;
        audit.additionalNotes = document.getElementById('additionalNotes').value;
        audit.photos = [...photoNames];
        audit.synced = false;
        audit.timestamp = new Date().toISOString();
        auditData[idx] = audit;
        // PATCH: Update in backend
        await fetch(`/api/audits/${audit.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(audit)
        });
    } else {
        // New audit
        audit = {
            id: Date.now(),
            schoolName: document.getElementById('schoolName').value,
            localGov: document.getElementById('localGov').value,
            schoolAddress: document.getElementById('schoolAddress').value,
            latitude: parseFloat(document.getElementById('latitude').value) || null,
            longitude: parseFloat(document.getElementById('longitude').value) || null,
            principalName: document.getElementById('principalName').value,
            totalTeachers: parseInt(document.getElementById('totalTeachers').value) || 0,
            totalStudents: parseInt(document.getElementById('totalStudents').value) || 0,
            facilityCondition: document.getElementById('facilityCondition').value,
            additionalNotes: document.getElementById('additionalNotes').value,
            photos: [...photoNames],
            auditor: currentUser,
            timestamp: new Date().toISOString(),
            synced: false
        };
        auditData.push(audit);
        // PATCH: Save to backend
        await fetch('/api/audits', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(audit)
        });
    }
    saveData();
    updateDashboard();
    loadRecords();
    // Reset edit mode
    form.removeAttribute('data-edit-id');
    alert('Audit saved successfully!');
    // Reset form
    event.target.reset();
    uploadedFiles = [];
    document.getElementById('uploadedFiles').innerHTML = '';
    document.getElementById('localGov').value = '';
    document.getElementById('schoolName').innerHTML = '<option value="">Select LGA first</option>';
    document.getElementById('schoolName').disabled = true;
    updateDashboard();
    document.querySelector('#auditForm button[type="submit"]').textContent = "💾 Save Audit";
}

// PATCH: Delete audit from backend
async function deleteRecord(id) {
    if (!confirm('Are you sure you want to delete this audit?')) return;
    const idx = auditData.findIndex(a => a.id == id);
    if (idx === -1) return alert('Audit not found.');
    // Remove from backend
    await fetch(`/api/audits/${id}`, { method: 'DELETE' });
    auditData.splice(idx, 1);
    saveData();
    loadRecords();
    updateDashboard && updateDashboard();
}

// --- PATCH: Bulk delete and bulk edit for records page ---
function getSelectedRecordIds() {
    const checkboxes = document.querySelectorAll('#recordsTable input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
}

async function bulkDeleteRecords() {
    const ids = getSelectedRecordIds();
    if (ids.length === 0) {
        alert('Select at least one record to delete.');
        return;
    }
    if (!confirm(`Are you sure you want to delete ${ids.length} selected record(s)?`)) return;
    for (const id of ids) {
        await fetch(`/api/audits/${id}`, { method: 'DELETE' });
        const idx = auditData.findIndex(a => a.id == id);
        if (idx !== -1) auditData.splice(idx, 1);
    }
    saveData();
    loadRecords();
    if (typeof updateDashboard === 'function') updateDashboard();
}

function bulkEditRecords() {
    const ids = getSelectedRecordIds();
    if (ids.length === 0) {
        alert('Select at least one record to edit.');
        return;
    }
    if (ids.length > 1) {
        alert('Bulk edit only supports editing one record at a time. Please select only one record.');
        return;
    }
    // Trigger edit for the first selected record
    editRecord(ids[0]);
}

// --- PATCH: Update dashboard stat cards and recent audits table from auditData ---
function updateDashboard() {
    // Defensive: ensure auditData is loaded
    if (!Array.isArray(auditData)) auditData = [];
    // Stat cards
    const totalAudits = auditData.length;
    const pendingSync = auditData.filter(a => !a.synced).length;
    // Completed today: audits with timestamp from today
    const today = new Date();
    const completedToday = auditData.filter(audit => {
        if (!audit.timestamp) return false;
        const d = new Date(audit.timestamp);
        return d.getFullYear() === today.getFullYear() &&
               d.getMonth() === today.getMonth() &&
               d.getDate() === today.getDate();
    }).length;
    document.getElementById('totalAudits').textContent = totalAudits;
    document.getElementById('pendingSync').textContent = pendingSync;
    document.getElementById('completedToday').textContent = completedToday;
    // Recent audits table (latest 5, most recent first)
    const recent = [...auditData].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 5);
    const table = document.getElementById('recentAuditsTable');
    if (!table) return;
    if (recent.length === 0) {
        table.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:#6b7280;">No audits completed yet</td></tr>';
    } else {
        table.innerHTML = recent.map(audit => `
            <tr>
                <td>${audit.schoolName || ''}</td>
                <td>${audit.localGov || ''}</td>
                <td>${audit.timestamp ? new Date(audit.timestamp).toLocaleString() : ''}</td>
                <td><span class="sync-status ${audit.synced ? 'synced' : 'pending'}">${audit.synced ? 'Synced' : 'Pending'}</span></td>
            </tr>
        `).join('');
    }
}

// --- PATCH: Update Sync section pending count from auditData ---
function updateSyncSection() {
    if (!Array.isArray(auditData)) auditData = [];
    const pending = auditData.filter(a => !a.synced).length;
    const el = document.getElementById('pendingSyncCount');
    if (el) el.textContent = pending;
}
// Patch updateDashboard to also update sync section
const origUpdateDashboard = window.updateDashboard;
window.updateDashboard = function() {
    origUpdateDashboard && origUpdateDashboard();
    updateSyncSection && updateSyncSection();
};

// Also call updateSyncSection after loadRecords, saveAudit, deleteRecord, bulkDeleteRecords, and after syncing audits if not already

// --- PATCH: Edit record from records page ---
function editRecord(id) {
    const audit = auditData.find(a => a.id == id);
    if (!audit) return alert('Audit not found.');
    // Show audit form section
    showSection('audit');
    // Populate form fields
    document.getElementById('localGov').value = audit.localGov || '';
    loadSchools();
    document.getElementById('schoolName').value = audit.schoolName || '';
    document.getElementById('schoolAddress').value = audit.schoolAddress || '';
    document.getElementById('latitude').value = audit.latitude || '';
    document.getElementById('longitude').value = audit.longitude || '';
    document.getElementById('principalName').value = audit.principalName || '';
    document.getElementById('totalTeachers').value = audit.totalTeachers || '';
    document.getElementById('totalStudents').value = audit.totalStudents || '';
    document.getElementById('facilityCondition').value = audit.facilityCondition || '';
    document.getElementById('additionalNotes').value = audit.additionalNotes || '';
    // Photos: preview existing images in edit mode
    uploadedFiles = [];
    const uploadedFilesDiv = document.getElementById('uploadedFiles');
    uploadedFilesDiv.innerHTML = '';
    if (audit.photos && Array.isArray(audit.photos) && audit.photos.length > 0) {
        audit.photos.forEach(filename => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-preview';
            fileDiv.innerHTML = `
                <img src="${getImageUrl(filename)}" alt="${filename}" style="width:100%;height:100%;object-fit:cover;">
                <a href="${getImageUrl(filename)}" target="_blank" class="file-download" title="View Full Image" style="position:absolute;bottom:5px;right:5px;background:rgba(30,64,175,0.8);color:#fff;padding:2px 8px;border-radius:6px;">🔍</a>
            `;
            uploadedFilesDiv.appendChild(fileDiv);
        });
    }
    document.getElementById('fileInput').disabled = false;
    document.getElementById('photoLimitMsg').style.display = 'none';
    const form = document.getElementById('auditForm');
    form.setAttribute('data-edit-id', audit.id);
    document.querySelector('#auditForm button[type="submit"]').textContent = '✏️ Update Audit';
}

// --- PATCH: Sync Now button logic ---
async function syncData() {
    // Find all unsynced audits
    const unsynced = auditData.filter(a => !a.synced);
    if (unsynced.length === 0) {
        alert('No pending records to sync.');
        return;
    }
    let success = 0, fail = 0;
    for (const audit of unsynced) {
        try {
            // Mark as synced and update backend
            audit.synced = true;
            await fetch(`/api/audits/${audit.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(audit)
            });
            success++;
        } catch (e) {
            fail++;
        }
    }
    saveData();
    updateDashboard();
    loadRecords();
    updateSyncSection();
    // Log result
    const log = document.getElementById('syncLog');
    if (log) {
        const msg = document.createElement('div');
        msg.style.margin = '10px 0';
        msg.style.color = (fail === 0) ? 'var(--lagos-green)' : 'var(--lagos-red)';
        msg.textContent = `Sync complete: ${success} record(s) synced${fail ? ', ' + fail + ' failed' : ''}.`;
        log.prepend(msg);
    }
    alert(`Sync complete: ${success} record(s) synced${fail ? ', ' + fail + ' failed' : ''}.`);
}

// --- PATCH: Display images in records table and audit form if available ---
// Helper to get image URL from filename
function getImageUrl(filename) {
    return `/api/photo/${encodeURIComponent(filename)}`;
}
// --- PATCH: Edit record from records page ---
function editRecord(id) {
    const audit = auditData.find(a => a.id == id);
    if (!audit) return alert('Audit not found.');
    showSection('audit');
    document.getElementById('localGov').value = audit.localGov || '';
    loadSchools();
    document.getElementById('schoolName').value = audit.schoolName || '';
    document.getElementById('schoolAddress').value = audit.schoolAddress || '';
    document.getElementById('latitude').value = audit.latitude || '';
    document.getElementById('longitude').value = audit.longitude || '';
    document.getElementById('principalName').value = audit.principalName || '';
    document.getElementById('totalTeachers').value = audit.totalTeachers || '';
    document.getElementById('totalStudents').value = audit.totalStudents || '';
    document.getElementById('facilityCondition').value = audit.facilityCondition || '';
    document.getElementById('additionalNotes').value = audit.additionalNotes || '';
    // Photos: preview existing images in edit mode
    uploadedFiles = [];
    const uploadedFilesDiv = document.getElementById('uploadedFiles');
    uploadedFilesDiv.innerHTML = '';
    if (audit.photos && Array.isArray(audit.photos) && audit.photos.length > 0) {
        audit.photos.forEach(filename => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-preview';
            fileDiv.innerHTML = `
                <img src="${getImageUrl(filename)}" alt="${filename}" style="width:100%;height:100%;object-fit:cover;">
                <a href="${getImageUrl(filename)}" target="_blank" class="file-download" title="View Full Image" style="position:absolute;bottom:5px;right:5px;background:rgba(30,64,175,0.8);color:#fff;padding:2px 8px;border-radius:6px;">🔍</a>
            `;
            uploadedFilesDiv.appendChild(fileDiv);
        });
    }
    document.getElementById('fileInput').disabled = false;
    document.getElementById('photoLimitMsg').style.display = 'none';
    const form = document.getElementById('auditForm');
    form.setAttribute('data-edit-id', audit.id);
    document.querySelector('#auditForm button[type="submit"]').textContent = '✏️ Update Audit';
}
    </script>

    <footer style="background:var(--lagos-navy);color:var(--lagos-yellow);text-align:center;padding:18px 0 10px 0;margin-top:40px;border-top:4px solid var(--lagos-green);font-size:1rem;letter-spacing:0.5px;">
  <img src="subeb.jpg" alt="Lagos State Logo" style="height:32px;width:32px;vertical-align:middle;margin-right:10px;border-radius:6px;border:2px solid var(--lagos-yellow);background:var(--lagos-white);">
  Lagos State Universal Basic Education Board &copy; 2025. All Rights Reserved. | Centre of Excellence
</footer>

<script>
// --- Survey Form Submission Logic for SILNAT, TCMATS, LORI, VOICES ---

// Helper: Convert FileList to array and resize images (returns array of base64 strings)
async function processFiles(input, maxCount) {
    const files = Array.from(input.files).slice(0, maxCount);
    const images = [];
    for (const file of files) {
        if (!file.type.startsWith('image/')) continue;
        const dataUrl = await resizeImage(file, 600, 0.6); // Use your resizeImage util
        images.push(dataUrl);
    }
    return images;
}

// --- SILNAT ---
async function submitSilnat(event) {
    event.preventDefault();
    const form = document.getElementById('silnatForm');
    const feedback = document.getElementById('silnat_feedback');
    feedback.textContent = '';
    // Validate required fields
    // Added silnat_b_institution_address to required fields
    const required = ['silnat_schoolName', 'silnat_b_institution_address', 'silnat_localGov','silnat_headTeacher','silnat_infrastructure','silnat_leadership','silnat_needs'];
    for (const id of required) {
        const element = document.getElementById(id);
        if (!element || !element.value.trim()) { // Added check for element existence
            feedback.style.color = 'var(--lagos-red)';
            feedback.textContent = 'Please fill all required fields.';
            return;
        }
    }
    feedback.textContent = 'Submitting...';
    feedback.style.color = 'var(--lagos-blue)';
    // Collect data
    const data = {
        schoolName: document.getElementById('silnat_schoolName').value.trim(),
        schoolAddress: document.getElementById('silnat_b_institution_address').value.trim(), // Added schoolAddress
        localGov: document.getElementById('silnat_localGov').value.trim(),
        headTeacher: document.getElementById('silnat_headTeacher').value.trim(),
        contact: document.getElementById('silnat_contact').value.trim(),
        infrastructure: document.getElementById('silnat_infrastructure').value,
        leadership: document.getElementById('silnat_leadership').value,
        needs: document.getElementById('silnat_needs').value.trim(),
        photos: await processFiles(document.getElementById('silnat_fileInput'), 5)
    };
    try {
        const res = await fetch('/api/silnat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (res.ok) {
            feedback.style.color = 'var(--lagos-green)';
            feedback.textContent = 'SILNAT survey submitted successfully!';
            form.reset();
            document.getElementById('silnat_uploadedFiles').innerHTML = '';
        } else {
            const err = await res.json();
            feedback.style.color = 'var(--lagos-red)';
            feedback.textContent = err.message || 'Submission failed.';
        }
    } catch (e) {
        feedback.style.color = 'var(--lagos-red)';
        feedback.textContent = 'Network error. Please try again.';
    }
}

// --- TCMATS ---
async function submitTcmats(event) {
    event.preventDefault();
    const form = document.getElementById('tcmatsForm');
    const feedback = document.getElementById('tcmats_feedback');
    feedback.textContent = '';
    const required = ['tcmats_teacherName','tcmats_school','tcmats_subject','tcmats_class','tcmats_observation'];
    for (const id of required) {
        if (!document.getElementById(id).value.trim()) {
            feedback.style.color = 'var(--lagos-red)';
            feedback.textContent = 'Please fill all required fields.';
            return;
        }
    }
    feedback.textContent = 'Submitting...';
    feedback.style.color = 'var(--lagos-blue)';
    const data = {
        teacherName: document.getElementById('tcmats_teacherName').value.trim(),
        school: document.getElementById('tcmats_school').value.trim(),
        subject: document.getElementById('tcmats_subject').value.trim(),
        class: document.getElementById('tcmats_class').value.trim(),
        observation: document.getElementById('tcmats_observation').value.trim(),
        evidence: await processFiles(document.getElementById('tcmats_fileInput'), 3)
    };
    try {
        const res = await fetch('/api/tcmats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (res.ok) {
            feedback.style.color = 'var(--lagos-green)';
            feedback.textContent = 'TCMATS survey submitted successfully!';
            form.reset();
            document.getElementById('tcmats_uploadedFiles').innerHTML = '';
        } else {
            const err = await res.json();
            feedback.style.color = 'var(--lagos-red)';
            feedback.textContent = err.message || 'Submission failed.';
        }
    } catch (e) {
        feedback.style.color = 'var(--lagos-red)';
        feedback.textContent = 'Network error. Please try again.';
    }
}

// --- LORI ---
async function submitLori(event) {
    event.preventDefault();
    const form = document.getElementById('loriForm');
    const feedback = document.getElementById('lori_feedback');
    feedback.textContent = '';
    const required = ['lori_assessorName','lori_teacherName','lori_school','lori_class','lori_rating'];
    for (const id of required) {
        if (!document.getElementById(id).value.trim()) {
            feedback.style.color = 'var(--lagos-red)';
            feedback.textContent = 'Please fill all required fields.';
            return;
        }
    }
    feedback.textContent = 'Submitting...';
    feedback.style.color = 'var(--lagos-blue)';
    const data = {
        assessorName: document.getElementById('lori_assessorName').value.trim(),
        teacherName: document.getElementById('lori_teacherName').value.trim(),
        school: document.getElementById('lori_school').value.trim(),
        class: document.getElementById('lori_class').value.trim(),
        rating: document.getElementById('lori_rating').value,
        comments: document.getElementById('lori_comments').value.trim(),
        evidence: await processFiles(document.getElementById('lori_fileInput'), 3)
    };
    try {
        const res = await fetch('/api/lori', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (res.ok) {
            feedback.style.color = 'var(--lagos-green)';
            feedback.textContent = 'LORI survey submitted successfully!';
            form.reset();
            document.getElementById('lori_uploadedFiles').innerHTML = '';
        } else {
            const err = await res.json();
            feedback.style.color = 'var(--lagos-red)';
            feedback.textContent = err.message || 'Submission failed.';
        }
    } catch (e) {
        feedback.style.color = 'var(--lagos-red)';
        feedback.textContent = 'Network error. Please try again.';
    }
}

// --- VOICES ---
async function submitVoices(event) {
    event.preventDefault();
    const form = document.getElementById('voicesForm');
    const feedback = document.getElementById('voices_feedback');
    feedback.textContent = '';
    const required = ['voices_learnerName','voices_age','voices_school','voices_class','voices_opinion'];
    for (const id of required) {
        if (!document.getElementById(id).value.trim()) {
            feedback.style.color = 'var(--lagos-red)';
            feedback.textContent = 'Please fill all required fields.';
            return;
        }
    }
    feedback.textContent = 'Submitting...';
    feedback.style.color = 'var(--lagos-blue)';
    const data = {
        learnerName: document.getElementById('voices_learnerName').value.trim(),
        age: document.getElementById('voices_age').value.trim(),
        school: document.getElementById('voices_school').value.trim(),
        class: document.getElementById('voices_class').value.trim(),
        opinion: document.getElementById('voices_opinion').value.trim(),
        evidence: await processFiles(document.getElementById('voices_fileInput'), 2)
    };
    try {
        const res = await fetch('/api/voices', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        if (res.ok) {
            feedback.style.color = 'var(--lagos-green)';
            feedback.textContent = 'VOICES survey submitted successfully!';
            form.reset();
            document.getElementById('voices_uploadedFiles').innerHTML = '';
        } else {
            const err = await res.json();
            feedback.style.color = 'var(--lagos-red)';
            feedback.textContent = err.message || 'Submission failed.';
        }
    } catch (e) {
        feedback.style.color = 'var(--lagos-red)';
        feedback.textContent = 'Network error. Please try again.';
    }
}
</script>
</body>
</html>
